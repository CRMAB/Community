!async function(){"use strict";const e=await(async()=>{try{if(window.__ensureOverlayV2&&"function"==typeof window.__ensureOverlayV2.ensureOverlayV2)return await window.__ensureOverlayV2.ensureOverlayV2()}catch(e){console.warn("ensureOverlayV2 failed:",e)}return window.__lvlUpOverlay||null})();if(!e||"function"!=typeof e.createOverlay)return void alert("Overlay helpers are not available. Please load Helper Overlay V2.");const t="undefined"!=typeof Xrm&&Xrm.Utility&&"function"==typeof Xrm.Utility.getGlobalContext?Xrm.Utility.getGlobalContext():null;if(!t)return void alert("Global context is not available. Please run inside Dynamics 365.");const r=t.userSettings||{},o=r.userId||"",a=(n=o)?n.replace(/[{}]/g,"").toLowerCase():"";var n;if(!a)return void alert("Could not determine current user ID.");const i=r.userName||r.userId||"Unknown user",s={light:{primary:"#0078d4",primaryHover:"#106ebe",border:"#ddd",borderLight:"#eee",text:"#323130",textMuted:"#605e5c",textError:"#a4262c",bg:"#fff",bgHover:"#f3f2f1",bgError:"#fde7e9",textOnPrimary:"#fff",success:"#107c10",successHover:"#0e6b0e",danger:"#d13438",dangerHover:"#a80000",buttonSecondary:"#605e5c"},dark:{primary:"#60a5fa",primaryHover:"#3b82f6",border:"#374151",borderLight:"#4b5563",text:"#eef2ff",textMuted:"#9ca3af",textError:"#fca5a5",bg:"#1f2937",bgHover:"#374151",bgError:"#7f1d1d",textOnPrimary:"#fff",success:"#10b981",successHover:"#059669",danger:"#ef4444",dangerHover:"#dc2626",buttonSecondary:"#6b7280"}};let l=null;try{const e=localStorage.getItem("crmab-personalsettings-colors");e&&(l=JSON.parse(e))}catch(e){}const d=()=>{const e="dark"===g.host.getAttribute("data-theme")?"dark":"light";return l&&l[e]||s[e]};let c=[];const p=(e,t)=>{c.push({timestamp:new Date,message:e,type:t||"info"}),c.length>100&&c.shift()},g=e.createOverlay("Personal Settings",{rootId:"crmab-personal-settings-root",width:460,maxHeight:"75vh",footer:!0,footerText:"Loading..."});if(!g)return;const{body:u}=g;if(!u)return;u.style.paddingBottom="20px";const x=e=>document.createElement(e),h=(e,t)=>(e.textContent=t,e),f=(e,t)=>(e.style.cssText=t,e),b=d(),y=f(x("div"),"display:flex;flex-direction:column;gap:8px;margin-bottom:16px;");u.appendChild(y);const v=f(x("div"),`color:${b.textMuted};font-size:13px;line-height:1.5;`),m=h(x("strong"),"Personal Language Settings"),C=h(x("span"),"Select UI and help language. After saving, refresh the browser to apply the change.");v.appendChild(m),v.appendChild(x("br")),v.appendChild(C),y.appendChild(v);const $=f(x("div"),`font-size:12px;color:${b.text};background:${b.bgHover};padding:8px;border-radius:4px;`);$.textContent=`Current user: ${i}`,y.appendChild($);const k=f(x("div"),"display:flex;flex-direction:column;gap:12px;");y.appendChild(k);const w=(e,t)=>{const r=f(x("label"),`display:flex;flex-direction:column;gap:4px;font-size:12px;color:${b.text};`),o=f(x("span"),"font-weight:600;");return o.textContent=e,r.appendChild(o),r.appendChild(t),r},S=x("select");S.id="crmab-personal-language",S.className="crmab-select",S.style.cssText=`padding:8px;border:1px solid ${b.border};border-radius:4px;background:${b.bg};color:${b.text};`;const T=x("select");T.id="crmab-personal-help-language",T.className="crmab-select",T.style.cssText=`padding:8px;border:1px solid ${b.border};border-radius:4px;background:${b.bg};color:${b.text};`,S.addEventListener("change",(()=>{S.value&&T.value!==S.value&&(T.value=S.value,p(`Help language auto-synced to ${S.options[S.selectedIndex]?.text||S.value}`,"info"))}));const L=f(x("div"),`font-size:12px;color:${b.textMuted};`);k.appendChild(w("UI language",S)),k.appendChild(w("Help language",T)),k.appendChild(L);const O=f(x("div"),"display:flex;gap:8px;flex-wrap:wrap;"),E=h(x("button"),"Save");E.className="crmab-button",E.style.cssText=`padding:8px 16px;background:${b.primary};color:${b.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-size:12px;`,E.addEventListener("mouseenter",(function(){this.style.background=b.primaryHover})),E.addEventListener("mouseleave",(function(){this.style.background=b.primary})),O.appendChild(E),k.appendChild(O);const P=f(x("div"),`padding:8px;border-radius:4px;background:${b.bgHover};color:${b.textMuted};font-size:12px;`);P.id="crmab-personal-status",u.appendChild(P);const H=(e,t=!1)=>{P.textContent=e,P.style.background=t?b.bgError:b.bgHover,P.style.color=t?b.textError:b.textMuted,g.updateFooter&&g.updateFooter(t?`Error: ${e}`:e),p(e,t?"error":"info"),console.log("[PersonalSettings]",e)},I=()=>t.getClientUrl()+"/api/data/v9.2",N=async(e,t={})=>{const r=e.startsWith("http")?e:I()+e,o=await fetch(r,{...t,headers:{"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json",...t.headers||{}}});if(!o.ok){const e=await o.text();throw new Error(`HTTP ${o.status}: ${e||o.statusText}`)}return 204===o.status?null:o.json()},z=(e,t)=>{const r=x("option");r.value="",r.textContent=t,e.appendChild(r)};let A=null,M=[];const U={1025:"Arabic (Saudi Arabia)",1026:"Bulgarian",1027:"Catalan",1028:"Chinese (Traditional)",1029:"Czech",1030:"Danish",1031:"German (Germany)",1032:"Greek",1033:"English (USA)",1034:"Spanish (Spain)",1035:"Finnish",1036:"French",1037:"Hebrew",1038:"Hungarian",1040:"Italian",1041:"Japanese",1042:"Korean",1043:"Dutch",1044:"Norwegian (BokmÃ¥l)",1045:"Polish",1046:"Portuguese (Brazil)",1049:"Russian",1050:"Croatian",1051:"Slovak",1053:"Swedish",1054:"Thai",1055:"Turkish",1057:"Indonesian",1060:"Slovenian",1061:"Estonian",1062:"Latvian",1063:"Lithuanian",1066:"Vietnamese",1069:"Basque",1081:"Hindi",1094:"Malayalam",1104:"Mongolian",1110:"Galician",2052:"Chinese (Simplified)",2070:"Portuguese (Portugal)",3082:"Spanish (Mexico)"},R=async()=>{H("Loading available languages..."),M=[];try{const e=await N("/RetrieveProvisionedLanguages()"),t=e&&e.RetrieveProvisionedLanguages&&Array.isArray(e.RetrieveProvisionedLanguages)?e.RetrieveProvisionedLanguages:[];M=t.map((e=>({id:e,name:U[e]||`Language ${e}`,lcid:e})))}catch(e){console.warn("RetrieveProvisionedLanguages not available",e),p("RetrieveProvisionedLanguages failed: "+e.message,"error")}if(0===M.length){const e=r&&r.languageId?r.languageId:t.userSettings.uilanguageId,o=e?[e,1033,1031]:[1033,1031],a=Array.from(new Set(o));M=a.map((e=>({id:e,name:U[e]||`Language ${e}`,lcid:e}))),H("Provisioned languages could not be fetched. Fallback list loaded.",!0)}else H(`Languages loaded (${M.length}).`);[S,T].forEach((e=>{for(;e.firstChild;)e.removeChild(e.firstChild)})),z(S,"Please choose..."),z(T,"Please choose..."),M.forEach((e=>{const t=x("option");t.value=String(e.lcid),t.textContent=`${e.name} (${e.lcid})`,S.appendChild(t.cloneNode(!0)),T.appendChild(t)}))},D=e=>{const{value:t}=e;if(!t)return null;const r=Number(t);return Number.isNaN(r)?null:r},V=()=>{const t=e.createOverlay("Language Changed",{width:450,rootId:"personalsettings-refresh-overlay"});if(!t)return;const r=d(),o=x("div");o.style.cssText="display:flex;flex-direction:column;gap:16px;";const a=x("div");a.style.cssText=`font-size:14px;color:${r.text};line-height:1.6;`;const n=f(x("strong"),"display:block;margin-bottom:8px;font-size:16px;");n.textContent="âœ… Language settings saved!",a.appendChild(n);const i=f(x("p"),"margin:0 0 8px 0;");i.textContent="Click the button below to refresh the page. After the refresh, press Ctrl + Shift + R to complete the language change.",a.appendChild(i),o.appendChild(a);const s=x("div");s.style.cssText="display:flex;flex-direction:column;gap:10px;";const l=x("button"),c=document.createTextNode("ðŸ”„ "),g=x("strong");g.textContent="Refresh Page",l.appendChild(c),l.appendChild(g),l.style.cssText=`padding:12px 16px;background:${r.primary};color:${r.textOnPrimary};border:none;border-radius:6px;cursor:pointer;font-size:14px;text-align:center;`,l.addEventListener("mouseenter",(()=>{l.style.background=r.primaryHover})),l.addEventListener("mouseleave",(()=>{l.style.background=r.primary})),l.onclick=()=>{p("Performing refresh...","info"),(()=>{try{sessionStorage.clear()}catch(e){}try{const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);r&&(r.includes("cache")||r.includes("lang")||r.includes("uci"))&&e.push(r)}e.forEach((e=>localStorage.removeItem(e)))}catch(e){}window.location.reload()})()};const u=x("button");u.textContent="Refresh Later",u.style.cssText=`padding:10px 16px;background:transparent;color:${r.textMuted};border:1px solid ${r.border};border-radius:6px;cursor:pointer;font-size:13px;`,u.onclick=()=>{t.closeOverlay()},s.appendChild(l),s.appendChild(u),o.appendChild(s);const h=x("div");h.style.cssText=`margin-top:8px;padding:12px;background:${r.bgHover};border-radius:4px;font-size:12px;color:${r.text};line-height:1.6;`;const b=x("strong");b.textContent="ðŸ“‹ Steps to complete:",b.style.display="block",b.style.marginBottom="8px",h.appendChild(b);const y=x("ol");y.style.cssText="margin:0;padding-left:20px;";const v=x("li");v.textContent='Click "Refresh Page" above',y.appendChild(v);const m=x("li");m.appendChild(document.createTextNode("Press "));const C=f(x("kbd"),`background:${r.bg};padding:2px 6px;border-radius:3px;border:1px solid ${r.border};font-family:monospace;`);C.textContent="Ctrl + Shift + R",m.appendChild(C),m.appendChild(document.createTextNode(" to force reload")),y.appendChild(m);const $=x("li");$.style.color=r.textMuted,$.textContent="Reload Helper Overlay manually via LevelUp",y.appendChild($),h.appendChild(y);const k=x("div");k.style.cssText=`margin-top:10px;padding:8px;background:${r.bgError};border-radius:4px;font-size:11px;color:${r.textError};`,k.appendChild(document.createTextNode("âš ï¸ "));const w=x("strong");w.textContent="Note:",k.appendChild(w),k.appendChild(document.createTextNode(" After refresh, Helper Overlay must be reloaded manually via LevelUp.")),h.appendChild(k),o.appendChild(h),t.body.appendChild(o)};if(E.addEventListener("click",(async()=>{if(!A||!A.usersettingsid)return void H("User settings not loaded.",!0);const e=D(S),t=D(T);if(!e)return H("Please select a UI language.",!0),void S.focus();H("Saving settings..."),E.disabled=!0;try{await(async(e,t)=>{const r=await fetch(I()+e,{method:"PATCH",headers:{"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json","If-Match":"*"},body:JSON.stringify(t)});if(!r.ok){const e=await r.text();throw new Error(`HTTP ${r.status}: ${e||r.statusText}`)}})(`/usersettingscollection(${A.usersettingsid})`,{uilanguageid:e,helplanguageid:t||e}),H("Language settings saved successfully!"),p("Language settings saved: UI="+e+", Help="+(t||e),"info"),V()}catch(e){console.error("Update failed",e),H(`Save failed: ${e.message}`,!0)}finally{E.disabled=!1}})),g.footer){const t=h(x("button"),String.fromCharCode(9881)+" Settings");t.style.cssText=`background:transparent;border:1px solid ${b.border};color:${b.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;`,t.onclick=function(){const t=e.createOverlay("Settings",{width:500,rootId:"personalsettings-settings-overlay"});if(!t)return;let r="dark"===g.host.getAttribute("data-theme")?"dark":"light";const o=d(),a=x("div"),n=f(x("div"),"display:flex;gap:8px;margin-bottom:16px;"),i=h(x("button"),"â˜€ï¸ Light Mode"),c=h(x("button"),"ðŸŒ™ Dark Mode"),u=e=>`flex:1;padding:8px 16px;border:none;background:${e?o.primary:o.bgHover};color:${e?o.textOnPrimary:o.text};border-radius:4px;cursor:pointer;font-weight:600;`;i.style.cssText=u("light"===r),c.style.cssText=u("dark"===r);const b=x("div"),y={},v={},m=e=>{for(;b.firstChild;)b.removeChild(b.firstChild);y[e]={},v[e]={};const t=l&&l[e]||s[e];Object.keys(s[e]).forEach((r=>{const a=f(x("div"),"display:flex;align-items:center;gap:8px;margin-bottom:10px;"),n=h(f(x("label"),"flex:1;font-size:13px;color:"+o.text+";"),r),i=x("input");i.type="color",i.value=t[r],i.style.cssText="width:60px;height:32px;border:1px solid "+o.border+";border-radius:4px;cursor:pointer;",y[e][r]=i;const s=x("input");s.type="text",s.value=t[r],s.maxLength=7,s.placeholder="#000000",s.style.cssText="width:80px;padding:4px 8px;border:1px solid "+o.border+";border-radius:4px;font-family:monospace;font-size:12px;text-transform:uppercase;background:"+o.bg+";color:"+o.text+";",v[e][r]=s;const l=f(x("div"),`width:40px;height:32px;background:${t[r]};border:1px solid ${o.border};border-radius:4px;`),d=e=>{/^#[0-9A-Fa-f]{6}$/.test(e)&&(i.value=e,s.value=e.toUpperCase(),l.style.background=e)};i.addEventListener("input",(()=>{d(i.value)})),s.addEventListener("input",(()=>{const e=s.value.trim();"#"!==e.charAt(0)&&e.length>0&&(s.value="#"+e),d(s.value)})),s.addEventListener("blur",(()=>{/^#[0-9A-Fa-f]{6}$/.test(s.value)||(s.value=i.value)})),a.appendChild(n),a.appendChild(i),a.appendChild(s),a.appendChild(l),b.appendChild(a)}))};m(r),i.onclick=()=>{r="light",i.style.cssText=u(!0),c.style.cssText=u(!1),m("light")},c.onclick=()=>{r="dark",i.style.cssText=u(!1),c.style.cssText=u(!0),m("dark")},n.appendChild(i),n.appendChild(c),a.appendChild(n),a.appendChild(b);const C=f(x("div"),"display:flex;gap:8px;margin-top:16px;"),$=h(x("button"),"ðŸ’¾ Save");$.style.cssText=`flex:1;padding:8px 16px;background:${o.primary};color:${o.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`;const k=h(x("button"),"ðŸ”„ Reset to Defaults");k.style.cssText=`flex:1;padding:8px 16px;background:${o.bgHover};color:${o.text};border:1px solid ${o.border};border-radius:4px;cursor:pointer;font-weight:600;`;const w=h(x("button"),"âœ– Cancel");w.style.cssText=`flex:1;padding:8px 16px;background:${o.bgHover};color:${o.text};border:1px solid ${o.border};border-radius:4px;cursor:pointer;font-weight:600;`,$.onclick=()=>{const e={light:{},dark:{}};["light","dark"].forEach((t=>{y[t]?Object.keys(y[t]).forEach((r=>{e[t][r]=y[t][r].value})):e[t]=l&&l[t]||s[t]}));try{localStorage.setItem("crmab-personalsettings-colors",JSON.stringify(e)),l=e,p("Settings saved","info"),t.closeOverlay(),g.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error saving settings: "+e.message)}},k.onclick=()=>{if(confirm("Reset all color settings to defaults?"))try{localStorage.removeItem("crmab-personalsettings-colors"),l=null,p("Settings reset to defaults","info"),t.closeOverlay(),g.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error resetting settings: "+e.message)}},w.onclick=()=>t.closeOverlay(),C.appendChild($),C.appendChild(k),C.appendChild(w),a.appendChild(C),t.body.appendChild(a)};const r=h(x("button"),String.fromCharCode(128276)+" Logs");r.style.cssText=`background:transparent;border:1px solid ${b.border};color:${b.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;margin-left:8px;`,r.onclick=function t(){const r=d(),o=e.createOverlay("Activity Logs",{width:600,rootId:"personalsettings-logs-overlay"});if(!o)return;const a=x("div");0===c.length?a.appendChild(h(f(x("div"),`padding:20px;text-align:center;color:${r.textMuted};`),"No activity logged yet.")):c.slice().reverse().forEach((e=>{const t=f(x("div"),`padding:8px 12px;border-bottom:1px solid ${r.borderLight};font-size:12px;color:${"error"===e.type?r.textError:r.textMuted};`),o=f(x("span"),"font-weight:600;margin-right:8px;");o.textContent=e.timestamp.toLocaleTimeString();const n=x("span");n.textContent=e.message,t.appendChild(o),t.appendChild(n),a.appendChild(t)}));const n=h(x("button"),"ðŸ—‘ Clear Logs");n.style.cssText=`width:100%;margin-top:12px;padding:8px;background:${r.danger};color:${r.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,n.onclick=()=>{confirm("Clear all logs?")&&(c=[],o.closeOverlay(),t())},a.appendChild(n),o.body.appendChild(a)},g.footer.insertBefore(t,g.footer.firstChild),g.footer.insertBefore(r,g.footer.children[1])}try{await R(),await(async()=>{H("Loading user settings...");try{const e=await N(`/usersettingscollection(${a})?$select=uilanguageid,helplanguageid,localeid`);if(!e)throw new Error("User settings could not be found.");A={usersettingsid:a,uilanguageid:e.uilanguageid||null,helplanguageid:e.helplanguageid||null,localeid:e.localeid||null},S.value=A.uilanguageid?String(A.uilanguageid):"",T.value=A.helplanguageid?String(A.helplanguageid):"";const t=A.localeid?`Format LCID: ${A.localeid}`:"No locale ID available";L.textContent=`Current locale: ${t}`,H("User settings fetched.")}catch(e){throw H(`Load failed: ${e.message}`,!0),e}})()}catch(e){console.warn("Initialization incomplete",e)}}();