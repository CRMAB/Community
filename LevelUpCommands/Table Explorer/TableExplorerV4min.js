!async function(){const{createOverlay:e}=window.__lvlUpOverlay||(alert("Overlay helpers not loaded"),{});if(!e)return;const t=e("Table Explorer",{rootId:"crmab-tableexplorer-root",width:1e3,maxHeight:"88vh",footer:!0,footerText:"Select entity..."});if(t){t.body&&(t.body.style.maxHeight="80vh",t.body.style.overflowY="auto",t.body.style.paddingBottom="20px");try{const e=Xrm.Utility.getGlobalContext(),a=e=>document.createElement(e),o=(e,t)=>(e.textContent=t,e),n=(e,t)=>(e.style.cssText=t,e),i=e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},r=()=>e.getClientUrl()+"/api/data/v9.2",s=()=>({"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json"}),l=async e=>{const t=await fetch(r()+e,{headers:s()});if(!t.ok)throw new Error("HTTP "+t.status);return t.json()},d=async(e,t)=>{const a=await fetch(r()+e,{method:"PATCH",headers:{...s(),"If-Match":"*"},body:JSON.stringify(t)});if(!a.ok)throw new Error("HTTP "+a.status)},p=async(e,t)=>{const a=await fetch(r()+e,{method:"POST",headers:s(),body:JSON.stringify(t)});if(!a.ok)throw new Error("HTTP "+a.status);return a.json()},c=e=>{try{return e&&e.UserLocalizedLabel&&e.UserLocalizedLabel.Label||""}catch(e){return""}},u=e=>{if(null==e)return"";if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return String(e);if(e&&"object"==typeof e&&"Value"in e)return String(e.Value);try{if(e.UserLocalizedLabel&&e.UserLocalizedLabel.Label)return e.UserLocalizedLabel.Label}catch(e){}try{return JSON.stringify(e)}catch(t){return String(e)}},m=[],g=(e,t="info")=>{const a=(new Date).toISOString().substr(11,8);m.push({timestamp:a,level:t,message:e}),console.log(`[${a}] [${t.toUpperCase()}] ${e}`)},f=()=>{const e="dark"===t.host.getAttribute("data-theme"),n=e?{bg:"#1f2937",text:"#eef2ff",border:"#374151",codeBg:"#0b1220"}:{bg:"#fff",text:"#323130",border:"#e1e1e1",codeBg:"#f3f2f1"},i=a("div");i.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999999;background:${n.bg};color:${n.text};border:1px solid ${n.border};border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.5);width:800px;max-height:70vh;padding:16px;`;const r=o(a("div"),"Activity Log");r.style.cssText="font:600 16px Segoe UI;margin-bottom:12px;";const s=a("pre");s.style.cssText=`background:${n.codeBg};padding:12px;overflow:auto;max-height:500px;font-size:12px;font-family:Consolas,monospace;margin:0;color:${n.text};border:1px solid ${n.border};border-radius:4px;`,s.textContent=m.map((e=>`[${e.timestamp}] [${e.level.toUpperCase()}] ${e.message}`)).join("\n");const l=a("div");l.style.cssText="margin-top:12px;display:flex;gap:8px;";const d=o(a("button"),"Copy to Clipboard");d.style.cssText="padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;",d.onclick=()=>{navigator.clipboard.writeText(s.textContent).then((()=>alert("Logs copied to clipboard"))).catch((()=>alert("Copy failed")))};const p=o(a("button"),"Close");p.style.cssText=`padding:6px 12px;background:${e?"#374151":"#e1e1e1"};color:${n.text};border:none;border-radius:4px;cursor:pointer;`,p.onclick=()=>document.body.removeChild(i),l.appendChild(d),l.appendChild(p),i.appendChild(r),i.appendChild(s),i.appendChild(l),document.body.appendChild(i)},b={light:{primary:"#0078d4",primaryHover:"#106ebe",border:"#ddd",borderLight:"#eee",text:"#323130",textMuted:"#605e5c",textError:"#a80000",bg:"#fff",bgHover:"#f3f2f1"},dark:{primary:"#60a5fa",primaryHover:"#3b82f6",border:"#374151",borderLight:"#4b5563",text:"#eef2ff",textMuted:"#9ca3af",textError:"#fca5a5",bg:"#1f2937",bgHover:"#374151"}};let h=null;try{const e=localStorage.getItem("crmab-tableexplorer-colors");e&&(h=JSON.parse(e))}catch(e){g("Failed to load custom colors from localStorage","error")}const y=()=>{const e="dark"===t.host.getAttribute("data-theme")?{bg:"#1f2937",text:"#eef2ff",border:"#374151",inputBg:"#0b1220",inputBorder:"#4b5563",btnBg:"#374151",btnText:"#eef2ff"}:{bg:"#fff",text:"#323130",border:"#e1e1e1",inputBg:"#f3f2f1",inputBorder:"#c8c6c4",btnBg:"#e1e1e1",btnText:"#323130"},n=a("div");n.style.cssText=`position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:999999;background:${e.bg};color:${e.text};border:1px solid ${e.border};border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.5);width:650px;max-height:85vh;overflow-y:auto;`;const r=o(a("div"),"Color Scheme Settings");r.style.cssText="padding:20px 20px 16px 20px;font:600 18px Segoe UI;border-bottom:1px solid "+e.border;const s=a("div");s.style.cssText="padding:20px;";let l="light";const d=a("div");d.style.cssText="display:flex;gap:8px;margin-bottom:20px;";const p=o(a("button"),"â˜€ï¸ Light Mode"),c=o(a("button"),"ðŸŒ™ Dark Mode"),u=()=>{p.style.cssText=`padding:8px 16px;border:1px solid ${e.border};border-radius:4px;cursor:pointer;background:${"light"===l?e.btnBg:"transparent"};color:${e.text};font-weight:${"light"===l?"600":"400"};`,c.style.cssText=`padding:8px 16px;border:1px solid ${e.border};border-radius:4px;cursor:pointer;background:${"dark"===l?e.btnBg:"transparent"};color:${e.text};font-weight:${"dark"===l?"600":"400"};`};u();const m=a("div"),f={},y=()=>{i(m),f[l]={};const t=h&&h[l]||b[l];[{label:"Primary Color",key:"primary",desc:"Buttons, active tabs, accent elements"},{label:"Primary Hover",key:"primaryHover",desc:"Hover state for primary elements"},{label:"Border",key:"border",desc:"Main borders and dividers"},{label:"Border Light",key:"borderLight",desc:"Subtle borders and separators"},{label:"Text",key:"text",desc:"Primary text color"},{label:"Text Muted",key:"textMuted",desc:"Secondary, less prominent text"},{label:"Text Error",key:"textError",desc:"Error messages and warnings"},{label:"Background",key:"bg",desc:"Main background color"},{label:"Background Hover",key:"bgHover",desc:"Hover state for backgrounds"}].forEach((n=>{const{wrapper:i,input:r,preview:s}=((t,n,i)=>{const r=a("div");r.style.cssText="margin-bottom:16px;";const s=o(a("div"),t);s.style.cssText="margin-bottom:4px;font-size:13px;font-weight:600;";const l=o(a("div"),i);l.style.cssText="margin-bottom:6px;font-size:11px;color:"+e.textMuted;const d=a("div");d.style.cssText="display:flex;gap:8px;align-items:center;";const p=a("input");p.type="text",p.dataset.key=n,p.style.cssText=`flex:1;padding:8px;background:${e.inputBg};color:${e.text};border:1px solid ${e.inputBorder};border-radius:4px;font-family:Consolas,monospace;font-size:13px;`;const c=a("div");return c.style.cssText=`width:48px;height:48px;border:1px solid ${e.inputBorder};border-radius:4px;flex-shrink:0;`,p.addEventListener("input",(()=>{/^#[0-9A-Fa-f]{6}$/.test(p.value)?(c.style.background=p.value,p.style.borderColor=e.inputBorder):p.style.borderColor="#dc3545"})),d.appendChild(p),d.appendChild(c),r.appendChild(s),r.appendChild(l),r.appendChild(d),{wrapper:r,input:p,preview:c}})(n.label,n.key,n.desc);r.value=t[n.key],s.style.background=t[n.key],f[l][n.key]=r,m.appendChild(i)}))};p.onclick=()=>{l="light",u(),y()},c.onclick=()=>{l="dark",u(),y()},d.appendChild(p),d.appendChild(c),s.appendChild(d),s.appendChild(m);const x=a("div");x.style.cssText="display:flex;gap:8px;margin-top:20px;padding-top:20px;border-top:1px solid "+e.border;const v=o(a("button"),"ðŸ’¾ Save");v.style.cssText="padding:10px 20px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600;",v.onmouseenter=function(){this.style.background="#106ebe"},v.onmouseleave=function(){this.style.background="#0078d4"},v.onclick=()=>{const e={light:{},dark:{}};let t=!1;const a=l,o=f[a];if(Object.keys(o).forEach((n=>{const i=o[n].value;/^#[0-9A-Fa-f]{6}$/.test(i)?e[a][n]=i:(t=!0,o[n].style.borderColor="#dc3545")})),t)return void alert("Please fix invalid color values (must be hex format: #RRGGBB)");const i="light"===a?"dark":"light";e[i]=h&&h[i]||b[i],h=e;try{localStorage.setItem("crmab-tableexplorer-colors",JSON.stringify(h)),g("Custom colors saved successfully","success"),document.body.removeChild(n),alert("Color scheme saved! Please refresh the page to apply the new colors.")}catch(e){g("Failed to save custom colors: "+e.message,"error"),alert("Failed to save settings: "+e.message)}};const C=o(a("button"),"ðŸ”„ Reset to Defaults");C.style.cssText=`padding:10px 20px;background:${e.btnBg};color:${e.btnText};border:1px solid ${e.border};border-radius:4px;cursor:pointer;`,C.onmouseenter=function(){this.style.opacity="0.8"},C.onmouseleave=function(){this.style.opacity="1"},C.onclick=()=>{confirm("Reset all colors to defaults? This will clear your custom color scheme.")&&(h=null,localStorage.removeItem("crmab-tableexplorer-colors"),g("Colors reset to defaults","info"),document.body.removeChild(n),alert("Colors reset to defaults! Please refresh the page to see changes."))};const w=o(a("button"),"âœ– Cancel");w.style.cssText=`padding:10px 20px;background:transparent;color:${e.text};border:1px solid ${e.border};border-radius:4px;cursor:pointer;`,w.onmouseenter=function(){this.style.background=e.btnBg},w.onmouseleave=function(){this.style.background="transparent"},w.onclick=()=>document.body.removeChild(n),x.appendChild(v),x.appendChild(C),x.appendChild(w),s.appendChild(x),n.appendChild(r),n.appendChild(s),document.body.appendChild(n),y(),n.addEventListener("click",(e=>{e.target===n&&document.body.removeChild(n)}))};g("Table Explorer initialized","success");const x=n(a("div"),"margin-bottom:12px;display:flex;gap:8px;align-items:center;position:relative;"),v=a("select");v.style.cssText="max-width:250px;min-width:150px;padding:6px 8px;border:1px solid #ddd;border-radius:4px;";const C=o(a("button"),"ðŸŒ Environment Variables");C.style.cssText="padding:6px 16px;border:1px solid #0078d4;border-radius:4px;background:#0078d4;color:#fff;cursor:pointer;font-weight:600;white-space:nowrap;",C.addEventListener("mouseenter",(function(){this.style.background="#106ebe"})),C.addEventListener("mouseleave",(function(){this.style.background="#0078d4"})),C.onclick=()=>J("Environment Variables");const w=o(a("button"),"ðŸŒ Global Choices");w.style.cssText="padding:6px 16px;border:1px solid #0078d4;border-radius:4px;background:#0078d4;color:#fff;cursor:pointer;font-weight:600;white-space:nowrap;",w.addEventListener("mouseenter",(function(){this.style.background="#106ebe"})),w.addEventListener("mouseleave",(function(){this.style.background="#0078d4"})),w.onclick=()=>J("Global Choices"),x.appendChild(o(n(a("span"),"font-weight:600;"),"Entity:")),x.appendChild(v),x.appendChild(C),x.appendChild(w),t.body.appendChild(x);const N=n(a("div"),"display:flex;gap:4px;border-bottom:2px solid #ddd;margin-bottom:12px;flex-wrap:wrap;"),L={};let k="Properties";["Properties","1:N","N:1","N:N","Forms","Views","Fields","Option Sets","Business Rules","Plugins","JS","Prozesse"].forEach((e=>{const t=o(a("button"),e);t.className="crmab-te-tab",t.dataset.tab=e,t.style.cssText=`padding:8px 16px;border:none;border-bottom:3px solid ${k===e?"#0078d4":"transparent"};background:transparent;color:${k===e?"#0078d4":"#605e5c"};cursor:pointer;font-weight:${k===e?"600":"400"};`,t.addEventListener("mouseenter",(function(){k!==e&&(this.style.color="#323130")})),t.addEventListener("mouseleave",(function(){k!==e&&(this.style.color=k===e?"#0078d4":"#605e5c")})),t.addEventListener("click",(()=>J(e))),N.appendChild(t),L[e]=t})),t.body.appendChild(N);const E=n(a("div"),"min-height:400px;"),$=n(a("div"),"position:relative;margin-bottom:12px;display:none;"),S=a("input");S.type="text",S.placeholder="Search in current tab...",S.style.cssText="width:100%;padding:6px 28px 6px 8px;border:1px solid #ddd;border-radius:4px;";const T=o(a("button"),"Ã—");T.style.cssText="position:absolute;right:4px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#999;cursor:pointer;font-size:18px;line-height:1;padding:2px 6px;display:none;",T.onclick=()=>{S.value="",S.oninput&&S.oninput(),S.focus()},$.appendChild(S),$.appendChild(T),E.appendChild($);const M=a("div");E.appendChild(M),t.body.appendChild(E);let O=[],V=null,F=null,R=null,I=[],A=[],D=[],z=[],B=[],P=[],U=[],j=[],q=[],G={};const J=e=>{k=e,Object.keys(L).forEach((t=>{const a=L[t];a.style.borderBottomColor=t===e?"#0078d4":"transparent",a.style.color=t===e?"#0078d4":"#605e5c",a.style.fontWeight=t===e?"600":"400"})),$.style.display="block",S.value="",T.style.display="none",H(e)},H=async e=>{if(g(`Rendering tab: ${e}`,"info"),i(M),V||"Environment Variables"===e||"Global Choices"===e){M.appendChild(o(n(a("div"),"padding:8px;color:#605e5c;font-size:12px;"),"Loading..."));try{"Properties"===e?await Y():"1:N"===e?await _("OneToMany"):"N:1"===e?await _("ManyToOne"):"N:N"===e?await _("ManyToMany"):"Forms"===e?await W():"Views"===e?await K():"Fields"===e?await Q():"Option Sets"===e?await Z():"Business Rules"===e?await se():"Plugins"===e?await le():"JS"===e?await de():"Prozesse"===e?await pe():"Environment Variables"===e?await ce():"Global Choices"===e&&await ge()}catch(e){g(`Error rendering tab: ${e.message||e}`,"error"),i(M),M.appendChild(o(n(a("div"),"padding:20px;color:#a80000;"),"Error: "+(e.message||e)))}}else M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"Please select an entity"))},Y=async()=>{if(!F){const e=String.fromCharCode(39);F=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})`)}i(M);const e=new Set(["Attributes","ManyToManyRelationships","ManyToOneRelationships","OneToManyRelationships","DisplayName"]),a=[];for(const t in F)F.hasOwnProperty(t)&&!e.has(t)&&a.push({k:t,v:u(F[t])});a.sort(((e,t)=>e.k.toLowerCase().localeCompare(t.k.toLowerCase()))),oe(["Name","Value"],a.map((e=>[e.k,e.v]))),t.updateFooter&&t.updateFooter(`Properties: ${a.length}`)},_=async e=>{if(!R){const e=String.fromCharCode(39);try{const t=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})?$expand=ManyToOneRelationships($select=SchemaName,ReferencingEntity,ReferencedEntity,ReferencingAttribute,ReferencedAttribute,IsCustomRelationship,IsValidForAdvancedFind,IsCustomizable),OneToManyRelationships($select=SchemaName,ReferencingEntity,ReferencedEntity,ReferencingAttribute,ReferencedAttribute,IsCustomRelationship,IsValidForAdvancedFind,IsCustomizable),ManyToManyRelationships($select=SchemaName,Entity1LogicalName,Entity2LogicalName,IntersectEntityName,IsCustomRelationship,IsValidForAdvancedFind,IsCustomizable)`);R={ManyToOne:t.ManyToOneRelationships||[],OneToMany:t.OneToManyRelationships||[],ManyToMany:t.ManyToManyRelationships||[]}}catch(t){try{const t=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})?$expand=ManyToOneRelationships($select=SchemaName,ReferencingEntity,ReferencedEntity,ReferencingAttribute,ReferencedAttribute),OneToManyRelationships($select=SchemaName,ReferencingEntity,ReferencedEntity,ReferencingAttribute,ReferencedAttribute),ManyToManyRelationships($select=SchemaName,Entity1LogicalName,Entity2LogicalName,IntersectEntityName)`);R={ManyToOne:t.ManyToOneRelationships||[],OneToMany:t.OneToManyRelationships||[],ManyToMany:t.ManyToManyRelationships||[]}}catch(e){console.warn("Error loading relationships:",e),R={ManyToOne:[],OneToMany:[],ManyToMany:[]}}}}i(M);const a=R[e]||[];let o=[],n=[];"OneToMany"===e||"ManyToOne"===e?(o=["Schema","Referencing Entity","Referenced Entity","Referencing Attr","Referenced Attr","IsCustom","IsValidForAdvancedFind","IsCustomizable"],n=a.map((e=>[e.SchemaName||"",e.ReferencingEntity||"",e.ReferencedEntity||"",e.ReferencingAttribute||"",e.ReferencedAttribute||"",void 0!==e.IsCustomRelationship?e.IsCustomRelationship?"Yes":"No":"",void 0!==e.IsValidForAdvancedFind?e.IsValidForAdvancedFind?"Yes":"No":"",void 0!==e.IsCustomizable?e.IsCustomizable?"Yes":"No":""]))):"ManyToMany"===e&&(o=["Schema","Entity 1","Entity 2","Intersect Entity","IsCustom","IsValidForAdvancedFind","IsCustomizable"],n=a.map((e=>[e.SchemaName||"",e.Entity1LogicalName||"",e.Entity2LogicalName||"",e.IntersectEntityName||"",void 0!==e.IsCustomRelationship?e.IsCustomRelationship?"Yes":"No":"",void 0!==e.IsValidForAdvancedFind?e.IsValidForAdvancedFind?"Yes":"No":"",void 0!==e.IsCustomizable?e.IsCustomizable?"Yes":"No":""]))),oe(o,n,!0),t.updateFooter&&t.updateFooter(`${e}: ${n.length}`)},X=async e=>{if(G[e])return G[e];try{const t=(await l(`/systemforms(${e})?$select=formxml,name`)).formxml||"",a=(new DOMParser).parseFromString(t,"text/xml");if(a.getElementsByTagName("parsererror").length>0)return{libraries:[],handlers:[]};const o=[],n=a.getElementsByTagName("Library");for(let e=0;e<n.length;e++){const t=n[e],a=t.getAttribute("name")||"";a&&!o.some((e=>e.name===a))&&o.push({name:a,id:t.getAttribute("libraryUniqueId")||""})}const i=[],r=a.getElementsByTagName("event");for(let e=0;e<r.length;e++){const t=r[e],a=t.getAttribute("name")||"";let o="Form";const n=t.getAttribute("attribute")||"";n&&(o=n);const s=t.getElementsByTagName("handler");for(let e=0;e<s.length;e++){const t=s[e];i.push({target:o,event:a,library:t.getAttribute("libraryName")||"",functionName:t.getAttribute("functionName")||"",enabled:"false"!==t.getAttribute("enabled")})}}return G[e]={libraries:o,handlers:i},G[e]}catch(e){return console.warn("Error extracting form automations:",e),{libraries:[],handlers:[]}}},W=async()=>{if(0===I.length)try{const e=await l(`/systemforms?$select=formid,name&$filter=objecttypecode eq '${V}' and type eq 2`);I=(e.value||[]).map((e=>({id:e.formid||e.systemformid,name:e.name||""})))}catch(e){try{const e=String.fromCharCode(39),t=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})?$select=ObjectTypeCode`),a=t&&null!=t.ObjectTypeCode?t.ObjectTypeCode:null;if(null!=a){const e=await l(`/systemforms?$select=formid,name&$filter=objecttypecode eq ${a} and type eq 2`);I=(e.value||[]).map((e=>({id:e.formid||e.systemformid,name:e.name||""})))}else I=[]}catch(e){console.warn("Error loading forms:",e),I=[]}}i(M);const e=I.map((e=>[e.name,e.id,e]));oe(["Name","ID","Actions"],e,!0,((e,t,i)=>{if(2===t){const e=a("td");e.style.cssText="padding:6px 8px;border-bottom:1px solid #eee;";const t=n(a("div"),"display:flex;gap:4px;flex-wrap:wrap;"),r=i,s=o(a("button"),"ðŸ“œ JS");return s.style.cssText="padding:4px 8px;background:#0078d4;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;",s.addEventListener("mouseenter",(function(){this.style.background="#106ebe"})),s.addEventListener("mouseleave",(function(){this.style.background="#0078d4"})),s.addEventListener("click",(async()=>{const e=await X(r.id);J("JS"),U=e.handlers.map((e=>({form:r.name||"",target:e.target||"Form",event:e.event||"",library:e.library||"",functionName:e.functionName||"",enabled:e.enabled?"Yes":"No"}))),await de()})),t.appendChild(s),e.appendChild(t),e}return null})),t.updateFooter&&t.updateFooter(`Forms: ${I.length}`)},K=async()=>{if(0===A.length){const e=String.fromCharCode(39);try{const t=await l(`/savedqueries?$filter=returnedtypecode eq ${encodeURIComponent(e+V+e)} and statecode eq 0&$select=name,savedqueryid,returnedtypecode,fetchxml,layoutxml`);A=(t.value||[]).map((e=>({id:e.savedqueryid,name:e.name||"",type:"System",fetchxml:e.fetchxml||"",layoutxml:e.layoutxml||""})))}catch(e){A=[]}try{const t=((await l(`/userqueries?$filter=returnedtypecode eq ${encodeURIComponent(e+V+e)}&$select=name,userqueryid,returnedtypecode,fetchxml,layoutxml`)).value||[]).map((e=>({id:e.userqueryid,name:e.name||"",type:"Personal",fetchxml:e.fetchxml||"",layoutxml:e.layoutxml||""})));A=A.concat(t)}catch(e){}}i(M),ie(A),t.updateFooter&&t.updateFooter(`Views: ${A.length}`)},Q=async()=>{if(0===D.length){const e=String.fromCharCode(39);try{const t=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes?$select=LogicalName,SchemaName,AttributeType,DisplayName,RequiredLevel,IsCustomAttribute&$orderby=LogicalName`),a=e=>null==e?"":e?"Yes":"No";D=(t.value||[]).map((e=>({logicalName:e.LogicalName||"",schemaName:e.SchemaName||"",type:e.AttributeType||"",displayName:c(e.DisplayName)||"",requiredLevel:e.RequiredLevel&&e.RequiredLevel.Value?e.RequiredLevel.Value:"None",maxLength:"",minValue:"",maxValue:"",precision:"",isCustomAttribute:a(e.IsCustomAttribute)})));const o=new Map(D.map((e=>[e.logicalName.toLowerCase(),e])));try{((await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.StringAttributeMetadata?$select=LogicalName,MaxLength`)).value||[]).forEach((e=>{const t=o.get((e.LogicalName||"").toLowerCase());t&&(t.maxLength=null!=e.MaxLength?String(e.MaxLength):"")}))}catch(e){}try{((await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.DecimalAttributeMetadata?$select=LogicalName,MinValue,MaxValue,Precision`)).value||[]).forEach((e=>{const t=o.get((e.LogicalName||"").toLowerCase());t&&(t.minValue=null!=e.MinValue?String(e.MinValue):"",t.maxValue=null!=e.MaxValue?String(e.MaxValue):"",t.precision=null!=e.Precision?String(e.Precision):"")}))}catch(e){}try{((await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.IntegerAttributeMetadata?$select=LogicalName,MinValue,MaxValue`)).value||[]).forEach((e=>{const t=o.get((e.LogicalName||"").toLowerCase());t&&(t.minValue=null!=e.MinValue?String(e.MinValue):"",t.maxValue=null!=e.MaxValue?String(e.MaxValue):"")}))}catch(e){}try{((await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.DoubleAttributeMetadata?$select=LogicalName,MinValue,MaxValue,Precision`)).value||[]).forEach((e=>{const t=o.get((e.LogicalName||"").toLowerCase());t&&(t.minValue=null!=e.MinValue?String(e.MinValue):"",t.maxValue=null!=e.MaxValue?String(e.MaxValue):"",t.precision=null!=e.Precision?String(e.Precision):"")}))}catch(e){}try{((await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.MoneyAttributeMetadata?$select=LogicalName,MinValue,MaxValue,Precision`)).value||[]).forEach((e=>{const t=o.get((e.LogicalName||"").toLowerCase());t&&(t.minValue=null!=e.MinValue?String(e.MinValue):"",t.maxValue=null!=e.MaxValue?String(e.MaxValue):"",t.precision=null!=e.Precision?String(e.Precision):"")}))}catch(e){}D=Array.from(o.values())}catch(e){console.warn("Error loading fields:",e),D=[]}}i(M);oe(["Logical Name","Schema Name","Type","Display Name","Required","MaxLength","MinValue","MaxValue","Precision","IsCustomAttribute"],D.map((e=>{return[e.logicalName,e.schemaName,e.type,e.displayName,(t=e.requiredLevel,"ApplicationRequired"===t||"SystemRequired"===t?"Required":"Recommended"===t?"Recommended":"Optional"),e.maxLength||"",e.minValue||"",e.maxValue||"",e.precision||"",e.isCustomAttribute];var t})),!0),t.updateFooter&&t.updateFooter(`Fields: ${D.length}`)},Z=async()=>{if(0===z.length){const e=String.fromCharCode(39);try{const t=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.PicklistAttributeMetadata?$select=LogicalName,SchemaName&$expand=OptionSet($select=Name,IsGlobal,Options)`),a=await l(`/EntityDefinitions(LogicalName=${encodeURIComponent(e+V+e)})/Attributes/Microsoft.Dynamics.CRM.MultiSelectPicklistAttributeMetadata?$select=LogicalName,SchemaName&$expand=OptionSet($select=Name,IsGlobal,Options)`),o=(t.value||[]).map((e=>({logicalName:e.LogicalName||"",schemaName:e.SchemaName||"",optionSetName:e.OptionSet&&e.OptionSet.Name?e.OptionSet.Name:"",isGlobal:e.OptionSet&&e.OptionSet.IsGlobal?"Yes":"No",options:(e.OptionSet&&e.OptionSet.Options||[]).map((e=>({value:null!=e.Value?e.Value:"",label:c(e.Label)||""})))}))),n=(a.value||[]).map((e=>({logicalName:e.LogicalName||"",schemaName:e.SchemaName||"",optionSetName:e.OptionSet&&e.OptionSet.Name?e.OptionSet.Name:"",isGlobal:e.OptionSet&&e.OptionSet.IsGlobal?"Yes":"No",options:(e.OptionSet&&e.OptionSet.Options||[]).map((e=>({value:null!=e.Value?e.Value:"",label:c(e.Label)||""})))})));z=o.concat(n)}catch(e){console.warn("Error loading option sets:",e),z=[]}}if(i(M),0===z.length)return M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No option sets available")),void(t.updateFooter&&t.updateFooter("Option Sets: 0"));const e=[];z.forEach((t=>{t.options&&t.options.length>0?t.options.forEach(((a,o)=>{e.push([t.optionSetName||"",t.logicalName||"",t.schemaName||"",t.isGlobal||"",""!==a.value?String(a.value):"",a.label||""])})):e.push([t.optionSetName||"",t.logicalName||"",t.schemaName||"",t.isGlobal||"","","(no options)"])})),oe(["Option Set Name","Field Logical Name","Field Schema Name","Is Global","Value","Label"],e,!0),t.updateFooter&&t.updateFooter(`Option Sets: ${z.length} (${e.length} values)`)},ee=(e,t,n,i)=>{if(i){const a=i(e,t,n);if(a&&1===a.nodeType)return a}return o(a("td"),n||"")},te=(e,t,o)=>{const n=a("tr");return t.forEach((t=>{const a=e[t],i=ee(e,t,a,o);i.style.cssText="padding:6px 8px;border-bottom:1px solid #eee;",n.appendChild(i)})),n},ae=(e,t,o)=>{const n=new Blob([e],{type:o}),i=URL.createObjectURL(n),r=a("a");r.href=i,r.download=t,r.click(),URL.revokeObjectURL(i)},oe=(e,r,s=!1,l=null)=>{if(i(M),0===r.length)return void M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No data available"));const d=a("table");d.style.cssText="width:100%;border-collapse:collapse;font-size:12px;";const p=a("thead"),c=a("tr");let u=-1,m=1,g=null,f=e.map(((e,t)=>t));e.forEach(((t,d)=>{const y=a("th");y.style.cssText="padding:8px;text-align:left;border-bottom:2px solid #ddd;font-weight:600;background:#f8fafc;cursor:pointer;user-select:none;position:relative;",y.appendChild(o(a("span"),t+" "));const x=o(n(a("span"),"opacity:0.3;font-size:10px;"),"â‡…");y.appendChild(x),y.draggable=!0,y.dataset.columnIndex=d,y.ondragstart=e=>{g=d,e.dataTransfer.effectAllowed="move",y.style.opacity="0.5"},y.ondragend=()=>{y.style.opacity="1",g=null},y.ondragover=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",null!==g&&g!==d&&(y.style.background="#e0e7ff")},y.ondragleave=()=>{g!==d&&(y.style.background=u===d?"#f0f2f5":"#f8fafc")},y.ondrop=t=>{if(t.preventDefault(),null!==g&&g!==d){const t=f.indexOf(g),a=f.indexOf(d);-1!==t&&-1!==a&&((t,a)=>{const o=[...f],[n]=o.splice(t,1);o.splice(a,0,n),f=o;const i=f.map((t=>e[t])),d=r.map((e=>f.map((t=>e[t])))),p=r;oe(i,d,s,((e,t,a)=>{if(l){const o=f[t];return l(p.find((t=>t===e||JSON.stringify(t)===JSON.stringify(e)))||e,o,a)}return null}))})(t,a)}y.style.background=u===d?"#f0f2f5":"#f8fafc"},y.onclick=()=>{u===d?m=-m:(u=d,m=1);const e=f[d],t=[...r].sort(((t,a)=>{const o=(t[e]||"").toString().toLowerCase(),n=(a[e]||"").toString().toLowerCase(),i=parseFloat(o),r=parseFloat(n);return isNaN(i)||isNaN(r)?o.localeCompare(n)*m:(i-r)*m}));Array.from(p.querySelectorAll("th")).forEach(((e,t)=>{const a=e.querySelectorAll("span"),o=a.length>1?a[a.length-1]:null;o&&(t===d?(o.textContent=m>0?" â†‘":" â†“",o.style.opacity="1"):(o.textContent=" â‡…",o.style.opacity="0.3"))})),i(b),t.forEach(((e,t)=>{const a=te(e,f,l);a.dataset.rowIndex=t,b.appendChild(a)})),h()},y.onmouseenter=()=>{u!==d&&(y.style.background="#f0f2f5")},y.onmouseleave=()=>{u!==d&&(y.style.background="#f8fafc")},c.appendChild(y)})),p.appendChild(c),d.appendChild(p);const b=a("tbody");r.forEach(((e,t)=>{const a=te(e,f,l);a.dataset.rowIndex=t,b.appendChild(a)})),d.appendChild(b),M.appendChild(d);const h=()=>{const e=(S.value||"").toLowerCase();T.style.display=e?"block":"none",Array.from(b.children).forEach((t=>{const a=Array.from(t.children).map((e=>e.textContent)).join(" ").toLowerCase();t.style.display=!e||a.includes(e)?"":"none"}));const a=Array.from(b.children).filter((e=>"none"!==e.style.display)).length;if(t.updateFooter){const o=r.length;e?t.updateFooter(`${a} of ${o} result(s) shown`):t.updateFooter(`${o} result(s)`)}};$.style.display="block",S.oninput=h,S.placeholder=`Search in ${e.join(", ").toLowerCase()}...`;const y=n(a("div"),"display:flex;gap:8px;margin-bottom:12px;justify-content:flex-end;"),x=V||"entity",v=`${x}_${k.toLowerCase().replace(/\s+/g,"_")}`,C=(e,t,n,i)=>{const r=o(a("button"),e);return r.style.cssText="padding:4px 8px;background:#0078d4;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;",r.onclick=()=>ae(t,`${v}.${n}`,i),r},w=[e.map((e=>`"${e.replace(/"/g,'""')}"`)).join(",")].concat(r.map((e=>e.map((e=>`"${String(e||"").replace(/"/g,'""')}"`)).join(",")))).join("\n"),N=JSON.stringify({entity:x,tab:k,headers:e,rows:r},null,2),L=[`# ${k}: ${x}`,"","| "+e.join(" | ")+" |","|"+e.map((()=>"---")).join("|")+"|"].concat(r.map((e=>"| "+e.map((e=>String(e||"").replace(/\n/g," "))).join(" | ")+" |"))).join("\n");y.appendChild(C("ðŸ“Š CSV",w,"csv","text/csv")),y.appendChild(C("ðŸ“„ JSON",N,"json","application/json")),y.appendChild(C("ðŸ“ MD",L,"md","text/markdown")),M.insertBefore(y,d)},ne=(e,t)=>{try{const a=(new DOMParser).parseFromString(e,"text/xml");if(a.getElementsByTagName("parsererror").length>0)throw new Error("XML parse error");const o=(e,t=0)=>{let a="";const n="  ".repeat(t);if(1===e.nodeType){a+=n+"<"+e.nodeName;for(let t=0;t<e.attributes.length;t++){const o=e.attributes[t];a+=" "+o.name+'="'+o.value+'"'}if(0===e.childNodes.length)a+=" />\n";else{a+=">\n";for(let n=0;n<e.childNodes.length;n++)a+=o(e.childNodes[n],t+1);a+=n+"</"+e.nodeName+">\n"}}else if(3===e.nodeType){const t=e.textContent.trim();t&&(a+=n+t+"\n")}return a};ae('<?xml version="1.0" encoding="utf-8"?>\n'+o(a.documentElement),t,"application/xml")}catch(a){ae(e,t,"application/xml")}},ie=e=>{if(i(M),0===e.length)return void M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No views available"));const r=e.map((e=>[e.name||"",e.id||"",e.type||"",e]));oe(["Name","ID","Type","Actions"],r,!0,((e,t,i)=>{if(3===t){const e=a("td");e.style.cssText="padding:6px 8px;border-bottom:1px solid #eee;";const t=n(a("div"),"display:flex;gap:4px;flex-wrap:wrap;"),r=i,s=(e,n,i,s,l)=>{if(!n)return;const d=o(a("button"),e);d.style.cssText=`padding:4px 8px;background:${s};color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;`,d.addEventListener("mouseenter",(function(){this.style.background=l})),d.addEventListener("mouseleave",(function(){this.style.background=s})),d.addEventListener("click",(()=>ne(n,`${(r.name||"view").replace(/[^a-z0-9]/gi,"_")}_${r.id}.${i}`))),t.appendChild(d)};return s("ðŸ“¥ FetchXML",r.fetchxml,"fetchxml","#0078d4","#106ebe"),s("ðŸ“‹ LayoutXML",r.layoutxml,"layoutxml","#107c10","#0e6b0d"),0===t.children.length&&t.appendChild(o(a("span"),"â€”")),e.appendChild(t),e}return null})),t.updateFooter&&t.updateFooter(`Views: ${e.length}`)},re=async()=>{v.appendChild(o(a("option"),"Loading entities..."));try{const e=async t=>{const a=await l(t),o=a&&a.value?a.value:[];O=O.concat(o);const n=a["@odata.nextLink"]||a["odata.nextLink"];n&&await e(n)};await e("/EntityDefinitions?$select=LogicalName,SchemaName,DisplayName"),O.sort(((e,t)=>{const a=(c(e.DisplayName)||e.LogicalName||"").toLowerCase(),o=(c(t.DisplayName)||t.LogicalName||"").toLowerCase();return a.localeCompare(o)})),g(`Loaded ${O.length} entities`,"success"),i(v),v.appendChild(o(a("option"),"Select entity...")),O.forEach((e=>{const t=a("option");t.value=e.LogicalName,t.textContent=(c(e.DisplayName)?c(e.DisplayName)+" ":"")+"("+e.LogicalName+")",v.appendChild(t)}));let n=null;const r=()=>{n&&(n.parentElement&&n.parentElement.removeChild(n),n=null)};document.addEventListener("click",(e=>{x.contains(e.target)||n&&n.contains(e.target)||r()})),v.onchange=async()=>{if(V=v.value,!V)return i(M),F=null,R=null,I=[],A=[],D=[],B=[],P=[],U=[],j=[],q=[],G={},void(t.updateFooter&&t.updateFooter("Select entity..."));g(`Entity selected: ${V}`,"info"),F=null,R=null,I=[],A=[],D=[],B=[],P=[],U=[],j=[],q=[],G={},t.updateFooter&&t.updateFooter(`Loading ${V}...`),await H(k)},t.updateFooter&&t.updateFooter(`Loaded ${O.length} entities`),g(`Loaded ${O.length} entities`,"success")}catch(e){g(`Error loading entities: ${e.message||e}`,"error"),i(v),v.appendChild(o(a("option"),"Error loading entities")),t.updateFooter&&t.updateFooter("Error loading entities")}},se=async()=>{if(0===B.length)try{const e=await l(`/workflows?$select=workflowid,name,statecode&$filter=primaryentity eq '${V}' and category eq 2`);B=(e.value||[]).map((e=>({id:e.workflowid,name:e.name||"",status:0===e.statecode?"Active":"Inactive"})))}catch(e){console.warn("Error loading business rules:",e),B=[]}i(M),oe(["Name","ID","Status"],B.map((e=>[e.name,e.id,e.status])),!0),t.updateFooter&&t.updateFooter(`Business Rules: ${B.length}`)},le=async()=>{if(0===P.length)try{const e=((await l("/sdkmessageprocessingsteps?$select=sdkmessageprocessingstepid,name,stage,mode&$expand=sdkmessageid($select=name),sdkmessagefilterid($select=primaryobjecttypecode)&$orderby=name&$top=1000")).value||[]).filter((e=>{const t=e.sdkmessagefilterid?.primaryobjecttypecode;return!t||t===V}));P=e.map((e=>({id:e.sdkmessageprocessingstepid,name:e.name||"",stage:{10:"Pre-Validation",20:"Pre-Operation",40:"Post-Operation"}[e.stage]||e.stage||"",mode:{0:"Synchronous",1:"Asynchronous"}[e.mode]||e.mode||"",plugin:"",image:"",message:e.sdkmessageid?.name||""})))}catch(e){console.warn("Error loading plugins:",e),P=[]}i(M);const e=P.map((e=>[e.name,e.stage,e.mode,e.message||""]));oe(["Name","Stage","Mode","Message"],e,!0),t.updateFooter&&t.updateFooter(`Plugins: ${P.length}`)},de=async()=>{if(0===U.length)try{const e=await l(`/systemforms?$select=formid,name,formxml&$filter=objecttypecode eq '${V}' and type eq 2`),t=new Set,a=[];(e.value||[]).forEach((e=>{try{const o=(new DOMParser).parseFromString(e.formxml||"","text/xml");if(o.getElementsByTagName("parsererror").length>0)return;Array.from(o.getElementsByTagName("Library")).forEach((e=>{const a=e.getAttribute("name")||"";a&&t.add(a)})),Array.from(o.getElementsByTagName("event")).forEach((t=>{const o=t.getAttribute("name")||"";let n="Form";const i=t.getAttribute("attribute")||"";i&&(n=i),Array.from(t.getElementsByTagName("handler")).forEach((t=>{a.push({form:e.name||"",target:n,event:o,library:t.getAttribute("libraryName")||"",functionName:t.getAttribute("functionName")||"",enabled:"false"!==t.getAttribute("enabled")?"Yes":"No"})}))}))}catch(e){}})),U=a.length>0?a:Array.from(t).map((e=>({form:"",target:"",event:"",library:e,functionName:"",enabled:""})))}catch(e){console.warn("Error loading JavaScript:",e),U=[]}if(i(M),0===U.length)return M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No JavaScript automations found")),void(t.updateFooter&&t.updateFooter("JavaScript: 0"));if(U[0].form){const e={};U.forEach((t=>{const a=t.form||"(Unknown Form)";e[a]||(e[a]={});const o=t.event||"(Unknown Event)";e[a][o]||(e[a][o]=[]),e[a][o].push(t)}));const a=[];Object.keys(e).sort().forEach((t=>{Object.keys(e[t]).sort().forEach((o=>{e[t][o].forEach((e=>{const n="Form"===e.target?"Form":`Field: ${e.target}`;a.push([t,o,n,e.library||"",e.functionName||"",e.enabled||""])}))}))}));oe(["Form","Event","Target","Library","Function","Enabled"],a,!0),t.updateFooter&&t.updateFooter(`JavaScript: ${U.length} handlers across ${Object.keys(e).length} form(s)`)}else{const e=["Library Name"],a=U.map((e=>[e.library||""]));oe(e,a,!0),t.updateFooter&&t.updateFooter(`JavaScript: ${U.length} libraries`)}},pe=async()=>{if(0===j.length)try{const e=await l(`/workflows?$select=workflowid,name,statecode,category&$filter=primaryentity eq '${V}' and category eq 4`);j=(e.value||[]).map((e=>({id:e.workflowid,name:e.name||"",status:0===e.statecode?"Active":"Inactive"})))}catch(e){console.warn("Error loading processes:",e),j=[]}i(M),oe(["Name","ID","Status"],j.map((e=>[e.name,e.id,e.status])),!0),t.updateFooter&&t.updateFooter(`Business Process Flows: ${j.length}`)},ce=async()=>{if(0===q.length)try{const e=await l("/environmentvariabledefinitions?$select=environmentvariabledefinitionid,schemaname,displayname,type,defaultvalue,description&$expand=environmentvariabledefinition_environmentvariablevalue($select=environmentvariablevalueid,value)&$orderby=displayname");q=(e.value||[]).map((e=>({definitionId:e.environmentvariabledefinitionid,valueId:e.environmentvariabledefinition_environmentvariablevalue?.[0]?.environmentvariablevalueid||null,schemaName:e.schemaname||"",displayName:e.displayname||e.schemaname||"",type:1e8===e.type?"String":100000001===e.type?"Number":100000002===e.type?"Boolean":100000003===e.type?"JSON":"Unknown",defaultValue:e.defaultvalue||"â€”",currentValue:e.environmentvariabledefinition_environmentvariablevalue?.[0]?.value||"(not set)",description:e.description||""})))}catch(e){console.warn("Error loading environment variables:",e),q=[]}i(M);const e=n(a("div"),"display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;"),r=o(a("button"),"âž• Create Variable");r.style.cssText="padding:8px 16px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",r.addEventListener("click",(()=>me())),e.appendChild(r);const s=o(a("button"),"ðŸ”„ Refresh");if(s.style.cssText="padding:8px 16px;background:#605e5c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",s.addEventListener("click",(async()=>{q=[],await ce()})),e.appendChild(s),M.appendChild(e),0===q.length)return M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No environment variables found")),void(t.updateFooter&&t.updateFooter("Environment Variables: 0"));const d=q.map((e=>[e.displayName,e.schemaName,e.type,e.defaultValue,e.currentValue,e.description,e]));oe(["Display Name","Schema Name","Type","Default Value","Current Value","Description","Actions"],d,!0,((e,t,i)=>{if(6===t){const e=a("td");e.style.cssText="padding:6px 8px;border-bottom:1px solid #eee;";const t=n(a("div"),"display:flex;gap:4px;flex-wrap:wrap;"),r=i,s=o(a("button"),"âœï¸ Edit");return s.style.cssText="padding:4px 8px;background:#0078d4;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;",s.addEventListener("mouseenter",(function(){this.style.background="#106ebe"})),s.addEventListener("mouseleave",(function(){this.style.background="#0078d4"})),s.addEventListener("click",(()=>ue(r))),t.appendChild(s),e.appendChild(t),e}return null})),t.updateFooter&&t.updateFooter(`Environment Variables: ${q.length}`)},ue=e=>{const t=n(a("div"),"position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000000;display:flex;align-items:center;justify-content:center;"),i=n(a("div"),"background:#fff;border-radius:8px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;"),r=o(n(a("h3"),"margin:0 0 16px 0;font-size:18px;color:#323130;"),"Edit Environment Variable");i.appendChild(r);const s=n(a("div"),"display:flex;flex-direction:column;gap:12px;"),l=(e,t,i=!1)=>{const r=n(a("div"),"display:flex;flex-direction:column;gap:4px;"),s=o(n(a("label"),"font-weight:600;font-size:12px;color:#323130;"),e);r.appendChild(s);const l=a(i?"div":"input");return i?(l.style.cssText="padding:8px;border:1px solid #ddd;border-radius:4px;background:#f3f2f1;color:#605e5c;font-size:12px;",l.textContent=t):(l.type="text",l.value=t||"",l.style.cssText="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:12px;"),r.appendChild(l),{wrapper:r,input:l}},c=l("Display Name",e.displayName,!0);s.appendChild(c.wrapper);const u=l("Schema Name",e.schemaName,!0);s.appendChild(u.wrapper);const m=l("Type",e.type,!0);s.appendChild(m.wrapper);const g=l("Default Value",e.defaultValue);s.appendChild(g.wrapper);const f=l("Current Value",e.currentValue);s.appendChild(f.wrapper);const b=l("Description",e.description);s.appendChild(b.wrapper),i.appendChild(s);const h=n(a("div"),"display:flex;gap:8px;justify-content:flex-end;margin-top:16px;"),y=o(a("button"),"Cancel");y.style.cssText="padding:8px 16px;background:#605e5c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",y.addEventListener("click",(()=>document.body.removeChild(t))),h.appendChild(y);const x=o(a("button"),"Save");x.style.cssText="padding:8px 16px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",x.addEventListener("click",(async()=>{try{x.disabled=!0,x.textContent="Saving...",g.input.value!==e.defaultValue&&await d(`/environmentvariabledefinitions(${e.definitionId})`,{defaultvalue:g.input.value||null}),f.input.value!==e.currentValue&&(e.valueId?await d(`/environmentvariablevalues(${e.valueId})`,{value:f.input.value||null}):await p("/environmentvariablevalues",{value:f.input.value||null,schemaname:e.schemaName,"EnvironmentVariableDefinitionId@odata.bind":`/environmentvariabledefinitions(${e.definitionId})`})),b.input.value!==e.description&&await d(`/environmentvariabledefinitions(${e.definitionId})`,{description:b.input.value||null}),document.body.removeChild(t),q=[],await ce()}catch(e){alert("Error saving: "+(e.message||e)),x.disabled=!1,x.textContent="Save"}})),h.appendChild(x),i.appendChild(h),t.appendChild(i),document.body.appendChild(t),t.addEventListener("click",(e=>{e.target===t&&document.body.removeChild(t)}))},me=()=>{const e=n(a("div"),"position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000000;display:flex;align-items:center;justify-content:center;"),t=n(a("div"),"background:#fff;border-radius:8px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;"),i=o(n(a("h3"),"margin:0 0 16px 0;font-size:18px;color:#323130;"),"Create Environment Variable");t.appendChild(i);const r=n(a("div"),"display:flex;flex-direction:column;gap:12px;"),s=(e,t="text")=>{const i=n(a("div"),"display:flex;flex-direction:column;gap:4px;"),r=o(n(a("label"),"font-weight:600;font-size:12px;color:#323130;"),e);i.appendChild(r);const s=a("select"===t?"select":"input");return"select"===t?(s.style.cssText="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:12px;",["String","Number","Boolean","JSON"].forEach((e=>{const t=a("option");t.value=e,t.textContent=e,s.appendChild(t)}))):(s.type=t,s.style.cssText="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:12px;"),i.appendChild(s),{wrapper:i,input:s}},l=s("Display Name *");r.appendChild(l.wrapper);const d=s("Schema Name *");r.appendChild(d.wrapper);const c=s("Type *","select");r.appendChild(c.wrapper);const u=s("Default Value");r.appendChild(u.wrapper);const m=s("Current Value");r.appendChild(m.wrapper);const g=s("Description");r.appendChild(g.wrapper),t.appendChild(r);const f=n(a("div"),"display:flex;gap:8px;justify-content:flex-end;margin-top:16px;"),b=o(a("button"),"Cancel");b.style.cssText="padding:8px 16px;background:#605e5c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",b.addEventListener("click",(()=>document.body.removeChild(e))),f.appendChild(b);const h=o(a("button"),"Create");h.style.cssText="padding:8px 16px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;",h.addEventListener("click",(async()=>{try{if(!l.input.value||!d.input.value)return void alert("Display Name and Schema Name are required");h.disabled=!0,h.textContent="Creating...";const t={String:1e8,Number:100000001,Boolean:100000002,JSON:100000003},a={displayname:l.input.value,schemaname:d.input.value,type:t[c.input.value]||1e8,description:g.input.value||null};u.input.value&&(a.defaultvalue=u.input.value);const o=await p("/environmentvariabledefinitions",a),n=o.environmentvariabledefinitionid||o.id;m.input.value&&await p("/environmentvariablevalues",{value:m.input.value,schemaname:d.input.value,"EnvironmentVariableDefinitionId@odata.bind":`/environmentvariabledefinitions(${n})`}),document.body.removeChild(e),q=[],await ce()}catch(e){alert("Error creating: "+(e.message||e)),h.disabled=!1,h.textContent="Create"}})),f.appendChild(h),t.appendChild(f),e.appendChild(t),document.body.appendChild(e),e.addEventListener("click",(t=>{t.target===e&&document.body.removeChild(e)}))},ge=async()=>{i(M),M.appendChild(o(n(a("div"),"padding:8px;color:#605e5c;font-size:12px;"),"Loading global choices..."));try{const e=((await l("/GlobalOptionSetDefinitions")).value||[]).map((e=>({name:e.Name||"",displayName:e.DisplayName?.UserLocalizedLabel?.Label||e.Name||"",type:"Picklist"===e.OptionSetType?"Picklist":"State"===e.OptionSetType?"State":"Status"===e.OptionSetType?"Status":"Boolean"===e.OptionSetType?"Boolean":"Unknown",metadataId:e.MetadataId||""})));if(i(M),0===e.length)return M.appendChild(o(n(a("div"),"padding:20px;text-align:center;color:#605e5c;"),"No global choices found")),void(t.updateFooter&&t.updateFooter("Global Choices: 0"));const r=["Display Name","Name","Type","Actions"],s=e.map((e=>[e.displayName,e.name,e.type,e]));oe(r,s,!0,((e,t,i)=>{if(3===t){const e=a("td");e.style.cssText="padding:6px 8px;border-bottom:1px solid #eee;";const t=i,r=o(a("button"),"ðŸ‘ï¸ View Details");return r.style.cssText="padding:4px 8px;background:#0078d4;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px;",r.addEventListener("mouseenter",(function(){this.style.background="#106ebe"})),r.addEventListener("mouseleave",(function(){this.style.background="#0078d4"})),r.addEventListener("click",(async()=>{try{const e=String.fromCharCode(39),i=await l(`/GlobalOptionSetDefinitions(Name=${e}${t.name}${e})/Microsoft.Dynamics.CRM.OptionSetMetadata`),r=n(a("div"),"position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000000;display:flex;align-items:center;justify-content:center;"),s=n(a("div"),"background:#fff;border-radius:8px;padding:24px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;"),d=o(n(a("h3"),"margin:0 0 16px 0;font-size:18px;color:#323130;"),"Global Choice: "+t.displayName);s.appendChild(d);const p=n(a("div"),"display:grid;grid-template-columns:150px 1fr;gap:8px;margin-bottom:16px;font-size:12px;"),c=(e,t)=>{p.appendChild(o(n(a("div"),"font-weight:600;color:#323130;"),e+":")),p.appendChild(o(n(a("div"),"color:#605e5c;"),t||"â€”"))};if(c("Name",i.Name),c("Display Name",i.DisplayName?.UserLocalizedLabel?.Label),c("Description",i.Description?.UserLocalizedLabel?.Label),c("Is Customizable",i.IsCustomizable?.Value?"Yes":"No"),s.appendChild(p),i.Options&&i.Options.length>0){const e=o(n(a("h4"),"margin:16px 0 8px 0;font-size:14px;color:#323130;"),"Options ("+i.Options.length+")");s.appendChild(e);const t=n(a("table"),"width:100%;border-collapse:collapse;font-size:12px;"),r=a("thead"),l=a("tr");["Value","Label","Color"].forEach((e=>{const t=o(n(a("th"),"padding:8px;background:#f3f2f1;text-align:left;font-weight:600;border-bottom:2px solid #ddd;"),e);l.appendChild(t)})),r.appendChild(l),t.appendChild(r);const d=a("tbody");i.Options.forEach((e=>{const t=a("tr");t.style.cssText="border-bottom:1px solid #eee;";const i=o(n(a("td"),"padding:8px;"),String(e.Value)),r=o(n(a("td"),"padding:8px;"),e.Label?.UserLocalizedLabel?.Label||"â€”"),s=n(a("td"),"padding:8px;");if(e.Color){const t=n(a("div"),`display:inline-block;width:16px;height:16px;background:${e.Color};border:1px solid #ddd;border-radius:2px;margin-right:8px;vertical-align:middle;`);s.appendChild(t),s.appendChild(o(a("span"),e.Color))}else s.textContent="â€”";t.appendChild(i),t.appendChild(r),t.appendChild(s),d.appendChild(t)})),t.appendChild(d),s.appendChild(t)}const u=o(a("button"),"Close");u.style.cssText="margin-top:16px;padding:8px 16px;background:#605e5c;color:#fff;border:none;border-radius:4px;cursor:pointer;",u.addEventListener("click",(()=>document.body.removeChild(r))),s.appendChild(u),r.appendChild(s),document.body.appendChild(r),r.addEventListener("click",(e=>{e.target===r&&document.body.removeChild(r)}))}catch(e){alert("Error loading details: "+(e.message||e))}})),e.appendChild(r),e}return null})),t.updateFooter&&t.updateFooter(`Global Choices: ${e.length}`),g(`Loaded ${e.length} global choices`,"success")}catch(e){g(`Error loading global choices: ${e.message||e}`,"error"),i(M),M.appendChild(o(n(a("div"),"padding:20px;color:#a80000;"),"Error: "+(e.message||e)))}};if(t.footer){const e=o(a("button"),String.fromCharCode(9881)+" Settings");e.title="Customize color scheme",e.style.cssText="margin-right:8px;padding:4px 8px;font-size:12px;background:transparent;border:1px solid currentColor;border-radius:4px;cursor:pointer;color:inherit;",e.onclick=y,t.footer.insertBefore(e,t.footer.lastChild);const n=o(a("button"),String.fromCharCode(128220)+" Logs");n.title="View activity logs",n.style.cssText="margin-right:8px;padding:4px 8px;font-size:12px;background:transparent;border:1px solid currentColor;border-radius:4px;cursor:pointer;color:inherit;",n.onclick=f,t.footer.insertBefore(n,t.footer.lastChild)}await re(),await H("Properties")}catch(e){console.error(e),"undefined"!=typeof addLog&&addLog(`Critical error: ${e.message||e}`,"error");const a=ce("div");a.style.cssText="color:#a80000;margin-top:8px;padding:12px;",a.textContent="Error: "+(e.message||e),t.body.appendChild(a)}}}();