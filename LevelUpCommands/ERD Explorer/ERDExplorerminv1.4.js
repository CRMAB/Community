!async function(){const{createOverlay:e}=window.__lvlUpOverlay||(alert("Overlay helpers not loaded"),{});if(!e)return;const t=e("ERD Explorer",{footer:!0});t.body&&(t.body.style.maxHeight="85vh",t.body.style.overflowY="auto",t.body.style.paddingBottom="20px",t.body.parentElement&&(t.body.parentElement.style.minWidth="700px",t.body.parentElement.style.maxWidth="900px",t.body.parentElement.style.maxHeight="90vh"));try{const e=Xrm.Utility.getGlobalContext(),r=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext();let i=r&&r.input&&r.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();const a=e=>document.createElement(e),n=(e,t)=>(e.textContent=t,e),o=(e,t)=>(e.style.cssText=t,e),d=e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},l=()=>e.getClientUrl()+"/api/data/v9.2",s=()=>({"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json"}),c=async e=>{const t=await fetch(l()+e,{headers:s()});if(!t.ok)throw new Error("HTTP "+t.status);return t.json()};let p={tables:{},relationships:[],relatedTables:new Set},m=!1,g=!1,y=null,u=null;const b=a("button");if(b.textContent="â”€",b.title="Minimize overlay",b.style.cssText="background:transparent;border:none;color:inherit;font-size:16px;cursor:pointer;padding:4px 8px;margin-right:4px;",t.header&&t.close){const e=a("div");e.style.cssText="display:flex;align-items:center;gap:4px;",t.header.removeChild(t.close),e.appendChild(b),e.appendChild(t.close),t.header.appendChild(e)}const x=()=>{g=!g,g?(t.body.style.display="none",t.footer&&(t.footer.style.display="none"),t.host.style.maxHeight="none",b.textContent="â–¡",b.title="Restore overlay"):(t.body.style.display="",t.footer&&(t.footer.style.display=""),t.host.style.maxHeight="90vh",b.textContent="â”€",b.title="Minimize overlay")};b.addEventListener("click",x);const f=async()=>{if(m)try{const e=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext(),t=e&&e.input&&e.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();t&&t!==y&&!p.tables[t]&&(y=t,i=t,P.textContent=t,oe("ðŸ”´ Auto-capturing: "+t+"..."),await ke(t),N("Auto-captured table: "+t,"info"))}catch(e){console.error("Auto-recording check failed:",e)}},h={light:{primary:"#0078d4",primaryHover:"#106ebe",border:"#ddd",borderLight:"#eee",text:"#323130",textMuted:"#605e5c",textError:"#a80000",bg:"#fff",bgHover:"#f3f2f1",bgError:"#fde7e9",textOnPrimary:"#fff",success:"#107c10",successHover:"#0e6b0e",danger:"#d13438",dangerHover:"#a80000",warning:"#ff0000"},dark:{primary:"#60a5fa",primaryHover:"#3b82f6",border:"#374151",borderLight:"#4b5563",text:"#eef2ff",textMuted:"#9ca3af",textError:"#fca5a5",bg:"#1f2937",bgHover:"#374151",bgError:"#7f1d1d",textOnPrimary:"#fff",success:"#10b981",successHover:"#059669",danger:"#ef4444",dangerHover:"#dc2626",warning:"#f87171"}};let v=null;try{const e=localStorage.getItem("crmab-erdexplorer-colors");e&&(v=JSON.parse(e))}catch(e){}const C=()=>{const e="dark"===t.host.getAttribute("data-theme")?"dark":"light";return v&&v[e]||h[e]};let E=[];const N=(e,t)=>{E.push({timestamp:new Date,message:e,type:t||"info"}),E.length>100&&E.shift()},k=C(),$=o(a("div"),`margin:8px 0;padding:12px;background:${k.primary};color:${k.textOnPrimary};border-radius:4px;display:flex;justify-content:space-between;align-items:center;`),w=n(o(a("span"),"font-weight:600;font-size:14px;"),"ðŸ“Š ERD Auto-Documentation"),L=o(a("div"),"display:flex;align-items:center;gap:8px;"),O=o(a("div"),`width:12px;height:12px;border-radius:50%;background:${k.warning};display:none;animation:blink 1.5s infinite;`),T=n(o(a("span"),"font-size:12px;display:none;"),"â— RECORDING");if(L.appendChild(O),L.appendChild(T),$.appendChild(w),$.appendChild(L),t.body.appendChild($),!document.getElementById("erd-explorer-styles")){const e=a("style");e.id="erd-explorer-styles",e.textContent="@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }",document.head.appendChild(e)}const M=o(a("div"),`margin:8px 0 12px 0;padding:8px;background:${k.bgHover};border-radius:4px;border-left:4px solid ${k.primary};`);M.appendChild(document.createTextNode("Current Table: "));const P=n(a("b"),i||"None found");M.appendChild(P),t.body.appendChild(M);const R=o(a("div"),"display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;"),A=(e,t)=>{e.style.cssText=`background:${t?k.bg:k.bgHover};color:${k.text};border:1px solid ${k.border};padding:4px 10px;border-radius:3px;cursor:pointer;font-weight:500;font-size:12px;transition:all 0.2s;`,e.addEventListener("mouseenter",(function(){this.style.background=k.primaryHover,this.style.borderColor=k.textMuted})),e.addEventListener("mouseleave",(function(){this.style.background=t?k.bg:k.bgHover,this.style.borderColor=k.border}))},S=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),z=n(a("button"),"â–¶ Start");A(z);const I=n(a("button"),"â¸ Stop");A(I),I.disabled=!0,I.style.opacity="0.5";const H=n(a("button"),"ðŸ“¸ Capture");A(H),S.appendChild(z),S.appendChild(I),S.appendChild(H);const j=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),D=n(a("button"),"â†‘ Import JSON");A(D);const F=n(a("button"),"â†“ Export JSON");A(F),j.appendChild(D),j.appendChild(F);const U=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),X=n(a("button"),"â†‘ Import ERD");A(X);const B=n(a("button"),"â†“ Export ERD");A(B);const J=n(a("button"),"ðŸ‘ View ERD");A(J),U.appendChild(X),U.appendChild(B),U.appendChild(J);const _=o(a("div"),"padding:6px;"),q=n(a("button"),"ðŸ—‘ Clear");A(q,!0),_.appendChild(q),R.appendChild(S),R.appendChild(j),R.appendChild(U),R.appendChild(_),t.body.appendChild(R);const V=o(a("div"),`margin:8px 0;padding:10px;background:${k.bgHover};border-radius:4px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;`),K=n(o(a("span"),`font-weight:600;font-size:12px;color:${k.text};`),"Mermaid ERD Mode:"),W=a("input");W.type="radio",W.name="mermaidMode",W.value="optimized",W.id="mode-opt",W.checked=!0;const Y=a("label");Y.htmlFor="mode-opt",Y.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,Y.appendChild(W),Y.appendChild(document.createTextNode("ðŸŽ¯ Optimized (Primary, Keys, Lookups)"));const G=a("input");G.type="radio",G.name="mermaidMode",G.value="full",G.id="mode-full";const Q=a("label");Q.htmlFor="mode-full",Q.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,Q.appendChild(G),Q.appendChild(document.createTextNode("ðŸ“‹ Complete (all fields)"));const Z=a("input");Z.type="radio",Z.name="mermaidMode",Z.value="tablesonly",Z.id="mode-tables";const ee=a("label");ee.htmlFor="mode-tables",ee.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,ee.appendChild(Z),ee.appendChild(document.createTextNode("ðŸ“¦ Tables Only (no fields)"));const te=a("input");te.type="radio",te.name="mermaidMode",te.value="custom",te.id="mode-custom";const re=a("label");re.htmlFor="mode-custom",re.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,re.appendChild(te),re.appendChild(document.createTextNode("âœï¸ Custom (per-table selection)")),V.appendChild(K),V.appendChild(Y),V.appendChild(Q),V.appendChild(ee),V.appendChild(re);const ie=a("input");ie.type="checkbox",ie.id="hide-self-ref",ie.style.cssText="margin-left:16px;";const ae=a("label");ae.htmlFor="hide-self-ref",ae.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,ae.appendChild(ie),ae.appendChild(document.createTextNode("ðŸ”„ Hide self-referencing")),V.appendChild(ae),t.body.appendChild(V);const ne=o(a("div"),`margin:8px 0;padding:8px;background:${k.bg};border:1px solid ${k.border};border-radius:4px;font-size:12px;color:${k.textMuted};`);ne.textContent='Ready. Click "Start Recording" or capture the current table.',t.body.appendChild(ne);const oe=(e,t)=>{ne.textContent=e,ne.style.color=t?k.textError:k.textMuted,ne.style.background=t?k.bgError:k.bg,e&&N(e,t?"error":"info")},de=o(a("div"),`margin:12px 0;padding:12px;background:${k.bg};border:1px solid ${k.border};border-radius:4px;display:flex;gap:16px;justify-content:space-around;flex-wrap:wrap;`),le=(e,t)=>{const r=o(a("div"),"flex:1;min-width:120px;text-align:center;");return r.appendChild(n(o(a("div"),`font-size:24px;font-weight:600;color:${k.primary};`),t)),r.appendChild(n(o(a("div"),`font-size:11px;color:${k.textMuted};text-transform:uppercase;margin-top:4px;`),e)),r},se=le("Tables","0"),ce=le("Relationships","0"),pe=le("Fields","0");de.appendChild(se),de.appendChild(ce),de.appendChild(pe),t.body.appendChild(de);const me=()=>{const e=Object.keys(p.tables).length,t=p.relationships.length,r=Object.values(p.tables).reduce(((e,t)=>e+(t.fields?t.fields.length:0)),0);se.firstChild.textContent=e,ce.firstChild.textContent=t,pe.firstChild.textContent=r},ge=n(o(a("div"),`font-weight:600;margin:16px 0 8px 0;padding:8px 0;border-bottom:2px solid ${k.primary};`),"Captured Tables");t.body.appendChild(ge);const ye=o(a("div"),`border:1px solid ${k.border};border-radius:4px;max-height:300px;overflow-y:auto;background:${k.bg};`),ue=n(o(a("div"),`padding:20px;text-align:center;color:${k.textMuted};`),"No tables captured yet.");ye.appendChild(ue),t.body.appendChild(ye);const be=n(o(a("div"),`font-weight:600;margin:16px 0 8px 0;padding:8px 0;border-bottom:2px solid ${k.success};`),"Related Tables (found via Relationships)");t.body.appendChild(be);const xe=o(a("div"),`padding:8px;background:${k.bgHover};border:1px solid ${k.border};border-bottom:none;border-radius:4px 4px 0 0;`),fe=a("input");fe.type="text",fe.placeholder="ðŸ” Search related tables...",fe.style.cssText=`width:100%;padding:6px 10px;border:1px solid ${k.border};border-radius:3px;font-size:12px;box-sizing:border-box;background:${k.bg};color:${k.text};`,xe.appendChild(fe),t.body.appendChild(xe);const he=o(a("div"),`border:1px solid ${k.border};border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;background:${k.bg};`),ve=n(o(a("div"),`padding:16px;text-align:center;color:${k.textMuted};font-size:11px;`),"No related tables found yet. Capture a table to see relationships.");he.appendChild(ve),t.body.appendChild(he);const Ce=e=>{const t=C(),r=window.__lvlUpOverlay.createOverlay("Select Fields: "+(e.displayName||e.logicalName),{width:600,rootId:"erd-fields-overlay-"+e.logicalName});if(!r)return;r.host&&(r.host.style.zIndex="9999990"),r.body.style.maxHeight="70vh",r.body.style.overflowY="auto";const i=document.querySelector('input[name="mermaidMode"]:checked').value;let l=new Set;if(e.customFields&&Array.isArray(e.customFields))e.customFields.forEach((e=>l.add(e)));else if("full"===i)(e.fields||[]).forEach((e=>l.add(e.logicalName)));else if("optimized"===i){const t=new Set;p.relationships.forEach((r=>{r.referencingEntity===e.logicalName&&r.referencingAttribute&&t.add(r.referencingAttribute.toLowerCase()),r.referencedEntity===e.logicalName&&r.referencedAttribute&&t.add(r.referencedAttribute.toLowerCase())})),(e.fields||[]).filter((e=>{const r=e.logicalName.toLowerCase();return e.isPrimaryId||e.isPrimaryName||t.has(r)})).forEach((e=>l.add(e.logicalName)))}const s=o(a("div"),`padding:12px;background:${t.bgHover};border-radius:4px;margin-bottom:12px;`),c=a("input");c.type="text",c.placeholder="ðŸ” Filter fields...",c.style.cssText=`width:100%;padding:8px 12px;border:1px solid ${t.border};border-radius:4px;font-size:13px;box-sizing:border-box;background:${t.bg};color:${t.text};margin-bottom:8px;`,s.appendChild(c);const m=o(a("div"),`font-size:12px;color:${t.textMuted};display:flex;justify-content:space-between;align-items:center;`),g=a("span");g.textContent=l.size+" of "+(e.fields?e.fields.length:0)+" fields selected";const y=o(a("div"),"display:flex;gap:8px;"),u=n(a("button"),"Select All");u.style.cssText=`padding:4px 8px;font-size:11px;background:${t.bg};border:1px solid ${t.border};border-radius:3px;cursor:pointer;color:${t.text};`;const b=n(a("button"),"Select None");b.style.cssText=`padding:4px 8px;font-size:11px;background:${t.bg};border:1px solid ${t.border};border-radius:3px;cursor:pointer;color:${t.text};`,y.appendChild(u),y.appendChild(b),m.appendChild(g),m.appendChild(y),s.appendChild(m),r.body.appendChild(s);const x=o(a("div"),`border:1px solid ${t.border};border-radius:4px;max-height:400px;overflow-y:auto;background:${t.bg};`),f=()=>{g.textContent=l.size+" of "+(e.fields?e.fields.length:0)+" fields selected"},h=r=>{d(x);const i=(r||"").toLowerCase(),s=(e.fields||[]).slice().sort(((e,t)=>e.isPrimaryId&&!t.isPrimaryId?-1:!e.isPrimaryId&&t.isPrimaryId?1:e.isPrimaryName&&!t.isPrimaryName?-1:!e.isPrimaryName&&t.isPrimaryName?1:e.logicalName.localeCompare(t.logicalName)));let c=0;if(s.forEach((e=>{if(!(!i||-1!==e.logicalName.toLowerCase().indexOf(i)||e.displayName&&-1!==e.displayName.toLowerCase().indexOf(i)||-1!==e.type.toLowerCase().indexOf(i)))return;c++;const r=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${t.borderLight};display:flex;align-items:center;gap:10px;cursor:pointer;`);r.addEventListener("mouseenter",(function(){this.style.background=t.bgHover})),r.addEventListener("mouseleave",(function(){this.style.background=l.has(e.logicalName)?t.bgHover:""})),l.has(e.logicalName)&&(r.style.background=t.bgHover);const d=a("input");d.type="checkbox",d.checked=l.has(e.logicalName),d.style.cssText="width:16px;height:16px;cursor:pointer;flex-shrink:0;";const s=a("div");s.style.flex="1";const p=o(a("div"),`font-weight:500;color:${t.text};font-size:13px;`);if(p.textContent=e.logicalName,e.isPrimaryId){const e=n(o(a("span"),`margin-left:6px;padding:1px 5px;background:${t.primary};color:${t.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"PK");p.appendChild(e)}if(e.isPrimaryName){const e=n(o(a("span"),`margin-left:6px;padding:1px 5px;background:${t.success};color:${t.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"NAME");p.appendChild(e)}const m=o(a("div"),`font-size:11px;color:${t.textMuted};margin-top:2px;`);m.textContent=(e.displayName||"")+" â€¢ "+e.type,s.appendChild(p),s.appendChild(m);const g=n(o(a("span"),`font-size:11px;color:${t.textMuted};background:${t.bgHover};padding:2px 6px;border-radius:3px;flex-shrink:0;`),e.type);r.addEventListener("click",(i=>{i.target!==d&&(l.has(e.logicalName)?(l.delete(e.logicalName),d.checked=!1,r.style.background=""):(l.add(e.logicalName),d.checked=!0,r.style.background=t.bgHover),f())})),d.addEventListener("change",(()=>{d.checked?(l.add(e.logicalName),r.style.background=t.bgHover):(l.delete(e.logicalName),r.style.background=""),f()})),r.appendChild(d),r.appendChild(s),r.appendChild(g),x.appendChild(r)})),0===c){const e=n(o(a("div"),`padding:20px;text-align:center;color:${t.textMuted};`),"No fields match the filter.");x.appendChild(e)}};h(""),r.body.appendChild(x),c.addEventListener("input",(function(){h(this.value)})),u.addEventListener("click",(()=>{(e.fields||[]).forEach((e=>l.add(e.logicalName))),f(),h(c.value)})),b.addEventListener("click",(()=>{l.clear(),f(),h(c.value)}));const v=o(a("div"),`display:flex;gap:8px;margin-top:16px;padding-top:12px;border-top:1px solid ${t.border};`),E=n(a("button"),"ðŸ’¾ Save Selection");E.style.cssText=`flex:1;padding:10px 16px;background:${t.primary};color:${t.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;`,E.addEventListener("mouseenter",(function(){this.style.background=t.primaryHover})),E.addEventListener("mouseleave",(function(){this.style.background=t.primary}));const k=n(a("button"),"âœ– Cancel");k.style.cssText=`flex:1;padding:10px 16px;background:${t.bgHover};color:${t.text};border:1px solid ${t.border};border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;`,E.addEventListener("click",(()=>{e.customFields=Array.from(l);const t=document.getElementById("mode-custom");t&&(t.checked=!0),N("Custom fields saved for "+e.logicalName+" ("+l.size+" fields)","info"),oe("âœ“ Custom field selection saved for "+(e.displayName||e.logicalName)),Ee(),r.closeOverlay()})),k.addEventListener("click",(()=>{r.closeOverlay()})),v.appendChild(E),v.appendChild(k),r.body.appendChild(v)},Ee=()=>{d(ye);const e=Object.values(p.tables);0!==e.length?e.forEach((e=>{const t=o(a("div"),`padding:10px 12px;border-bottom:1px solid ${k.borderLight};display:flex;justify-content:space-between;align-items:center;`);t.addEventListener("mouseenter",(function(){this.style.background=k.bgHover})),t.addEventListener("mouseleave",(function(){this.style.background=""}));const r=a("div");r.style.flex="1";const i=o(a("div"),`font-weight:600;color:${k.text};margin-bottom:4px;`);if(i.textContent=e.displayName||e.logicalName,e.customFields&&Array.isArray(e.customFields)){const t=n(o(a("span"),`margin-left:8px;padding:2px 6px;background:${k.primary};color:${k.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"CUSTOM: "+e.customFields.length);i.appendChild(t)}const d=o(a("div"),`font-size:11px;color:${k.textMuted};`);d.textContent=e.logicalName+" â€¢ "+(e.fields?e.fields.length:0)+" Fields â€¢ "+(e.relationshipsCount||0)+" Relationships",r.appendChild(i),r.appendChild(d);const l=o(a("div"),"display:flex;gap:6px;"),s=n(a("button"),"ðŸ“‹ Fields");s.style.cssText="background:"+k.primary+";color:"+k.textOnPrimary+";border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;",s.title="Select fields for ERD",s.addEventListener("mouseenter",(function(){this.style.background=k.primaryHover})),s.addEventListener("mouseleave",(function(){this.style.background=k.primary})),s.addEventListener("click",(t=>{t.stopPropagation(),Ce(e)}));const c=n(a("button"),"ðŸ—‘");c.style.cssText="background:"+k.danger+";color:"+k.textOnPrimary+";border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:14px;",c.title="Remove table",c.addEventListener("mouseenter",(function(){this.style.background=k.dangerHover})),c.addEventListener("mouseleave",(function(){this.style.background=k.danger})),c.addEventListener("click",(t=>{t.stopPropagation(),confirm('Remove table "'+(e.displayName||e.logicalName)+'"?')&&(delete p.tables[e.logicalName],p.relationships=p.relationships.filter((t=>t.referencedEntity!==e.logicalName&&t.referencingEntity!==e.logicalName&&t.entity1!==e.logicalName&&t.entity2!==e.logicalName)),N("Removed table: "+e.logicalName,"info"),me(),Ee(),Ne())})),l.appendChild(s),l.appendChild(c),t.appendChild(r),t.appendChild(l),ye.appendChild(t)})):ye.appendChild(n(o(a("div"),`padding:20px;text-align:center;color:${k.textMuted};`),"No tables captured yet."))},Ne=()=>{d(he);const e=Array.from(p.relatedTables).filter((e=>!p.tables[e])).sort(((e,t)=>e.localeCompare(t)));0!==e.length?e.forEach((e=>{const t=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${k.borderLight};display:flex;justify-content:space-between;align-items:center;`);t.setAttribute("data-table-name",e.toLowerCase()),t.addEventListener("mouseenter",(function(){this.style.background=k.bgHover})),t.addEventListener("mouseleave",(function(){this.style.background=""}));const r=o(a("div"),`font-weight:600;color:${k.text};font-size:12px;`);r.textContent=e;const i=n(a("button"),"+ Add");i.style.cssText="background:"+k.success+";color:"+k.textOnPrimary+";border:none;padding:4px 12px;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600;",i.addEventListener("mouseenter",(function(){this.style.background=k.successHover})),i.addEventListener("mouseleave",(function(){this.style.background=k.success})),i.addEventListener("click",(async t=>{t.stopPropagation(),await ke(e)})),t.appendChild(r),t.appendChild(i),he.appendChild(t)})):he.appendChild(n(o(a("div"),`padding:16px;text-align:center;color:${k.textMuted};font-size:11px;`),0===e.length&&Object.keys(p.tables).length>0?"All related tables already captured.":"No related tables found yet."))};fe.addEventListener("input",(function(){const e=this.value.toLowerCase();Array.from(he.children).forEach((t=>{const r=t.getAttribute("data-table-name");r&&(t.style.display=r.includes(e)?"":"none")}))}));const ke=async e=>{if(!e)return oe("No valid table specified.",!0),null;oe(`Analyzing table: ${e}...`);const t=String.fromCharCode(39);try{const r=await c(`/EntityDefinitions(LogicalName=${encodeURIComponent(t+e+t)})?$select=LogicalName,SchemaName,DisplayName,PrimaryIdAttribute,PrimaryNameAttribute,EntitySetName,Description&$expand=Attributes($select=LogicalName,AttributeType,DisplayName,Description,IsPrimaryId,IsPrimaryName;$filter=IsValidForRead eq true),OneToManyRelationships($select=SchemaName,ReferencedEntity,ReferencedAttribute,ReferencingEntity,ReferencingAttribute),ManyToOneRelationships($select=SchemaName,ReferencedEntity,ReferencedAttribute,ReferencingEntity,ReferencingAttribute),ManyToManyRelationships($select=SchemaName,Entity1LogicalName,Entity2LogicalName,IntersectEntityName)`),i={logicalName:r.LogicalName,schemaName:r.SchemaName,displayName:r.DisplayName?.UserLocalizedLabel?.Label||r.LogicalName,primaryIdAttribute:r.PrimaryIdAttribute,primaryNameAttribute:r.PrimaryNameAttribute,entitySetName:r.EntitySetName,description:r.Description?.UserLocalizedLabel?.Label||"",fields:[],relationshipsCount:0};r.Attributes&&r.Attributes.forEach((e=>{const t={logicalName:e.LogicalName,type:$e(e.AttributeType),displayName:e.DisplayName?.UserLocalizedLabel?.Label||e.LogicalName,description:e.Description?.UserLocalizedLabel?.Label||"",isPrimaryId:e.IsPrimaryId||!1,isPrimaryName:e.IsPrimaryName||!1};i.fields.push(t)}));const a=(t,r)=>{if(!t)return 0;let i=0;return t.forEach((t=>{const a={schemaName:t.SchemaName,type:r,referencedEntity:t.ReferencedEntity,referencedAttribute:t.ReferencedAttribute,referencingEntity:t.ReferencingEntity,referencingAttribute:t.ReferencingAttribute};p.relationships.some((e=>e.schemaName===a.schemaName))||(p.relationships.push(a),i++);const n="OneToMany"===r?t.ReferencingEntity:t.ReferencedEntity;n&&n!==e&&p.relatedTables.add(n)})),i};let n=0;return r.OneToManyRelationships&&(n+=a(r.OneToManyRelationships,"OneToMany")),r.ManyToOneRelationships&&(n+=a(r.ManyToOneRelationships,"ManyToOne")),r.ManyToManyRelationships&&r.ManyToManyRelationships.forEach((t=>{const r={schemaName:t.SchemaName,type:"ManyToMany",entity1:t.Entity1LogicalName,entity2:t.Entity2LogicalName,intersectEntity:t.IntersectEntityName};p.relationships.some((e=>e.schemaName===r.schemaName))||(p.relationships.push(r),n++),t.Entity1LogicalName!==e&&p.relatedTables.add(t.Entity1LogicalName),t.Entity2LogicalName!==e&&p.relatedTables.add(t.Entity2LogicalName)})),i.relationshipsCount=n,p.tables[e]?p.tables[e]={...p.tables[e],...i}:p.tables[e]=i,oe(`âœ“ Table "${i.displayName}" captured: ${i.fields.length} Fields, ${n} new Relationships`),me(),Ee(),Ne(),i}catch(t){return console.error(t),oe(`Error analyzing ${e}: ${t.message}`,!0),null}},$e=e=>({String:"string",Memo:"memo",Integer:"int",BigInt:"bigint",Decimal:"decimal",Double:"float",Money:"money",Boolean:"boolean",DateTime:"datetime",Lookup:"lookup",Customer:"lookup",Owner:"lookup",Uniqueidentifier:"guid",Picklist:"picklist",State:"state",Status:"status",Virtual:"virtual",ManagedProperty:"managedproperty",EntityName:"entityname"}[e]||e.toLowerCase()),we=(e,t)=>{if("tablesonly"===t)return[];if("custom"===t){if(e.customFields&&Array.isArray(e.customFields)&&e.customFields.length>0){const t=new Set(e.customFields);return(e.fields||[]).filter((e=>t.has(e.logicalName)))}return[]}if("optimized"===t){const t=new Set;return p.relationships.forEach((r=>{r.referencingEntity===e.logicalName&&r.referencingAttribute&&t.add(r.referencingAttribute.toLowerCase()),r.referencedEntity===e.logicalName&&r.referencedAttribute&&t.add(r.referencedAttribute.toLowerCase())})),(e.fields||[]).filter((e=>{const r=e.logicalName.toLowerCase();return e.isPrimaryId||e.isPrimaryName||t.has(r)}))}return e.fields||[]},Le=(e,t,r,i)=>{const a=new Set(Object.keys(r));let n=e;if(i&&(n=n.filter((e=>!("ManyToMany"===e.type&&e.entity1===e.entity2||"ManyToMany"!==e.type&&e.referencedEntity===e.referencingEntity)))),"full"===t)return n.filter((e=>"ManyToMany"===e.type?a.has(e.entity1)&&a.has(e.entity2):a.has(e.referencedEntity)&&a.has(e.referencingEntity)));if("tablesonly"===t)return n.filter((e=>"ManyToMany"===e.type?a.has(e.entity1)&&a.has(e.entity2):a.has(e.referencedEntity)&&a.has(e.referencingEntity)));if("optimized"===t){const e=new Set;return Object.values(r).forEach((t=>{(t.fields||[]).forEach((r=>{e.add(t.logicalName+"."+r.logicalName.toLowerCase())}))})),n.filter((t=>{if("ManyToMany"===t.type)return a.has(t.entity1)&&a.has(t.entity2);if(!(a.has(t.referencedEntity)&&a.has(t.referencingEntity)))return!1;const r=t.referencedEntity+"."+(t.referencedAttribute||"").toLowerCase(),i=t.referencingEntity+"."+(t.referencingAttribute||"").toLowerCase();return e.has(r)||e.has(i)}))}if("custom"===t){const e=new Set;return Object.values(r).forEach((t=>{(t.fields||[]).forEach((r=>{e.add(t.logicalName+"."+r.logicalName.toLowerCase())}))})),n.filter((t=>{if("ManyToMany"===t.type)return a.has(t.entity1)&&a.has(t.entity2);if(!(a.has(t.referencedEntity)&&a.has(t.referencingEntity)))return!1;const r=t.referencedEntity+"."+(t.referencedAttribute||"").toLowerCase(),i=t.referencingEntity+"."+(t.referencingAttribute||"").toLowerCase();return e.has(r)||e.has(i)}))}return n},Oe=(e,t)=>{let r="erDiagram\n";return Object.values(p.tables).forEach((t=>{r+=`    ${t.schemaName||t.logicalName} {\n`;we(t,e).forEach((e=>{let t=`        ${e.type} ${e.logicalName}`;e.isPrimaryId&&(t+=" PK"),e.logicalName.endsWith("id")&&!e.isPrimaryId&&(t+=" FK"),e.displayName&&(t+=` "${e.displayName}"`),r+=t+"\n"})),r+="    }\n\n"})),p.relationships.forEach((i=>{if(t){if("ManyToMany"===i.type&&i.entity1===i.entity2||"ManyToMany"!==i.type&&i.referencedEntity===i.referencingEntity)return}let a="";if("OneToMany"===i.type){const e=p.tables[i.referencedEntity],t=p.tables[i.referencingEntity];e&&t&&(a=`    ${e.schemaName||i.referencedEntity} ||--o{ ${t.schemaName||i.referencingEntity} : "${i.schemaName}"`)}else if("ManyToOne"===i.type){const e=p.tables[i.referencedEntity],t=p.tables[i.referencingEntity];e&&t&&(a=`    ${t.schemaName||i.referencingEntity} }o--|| ${e.schemaName||i.referencedEntity} : "${i.schemaName}"`)}else if("ManyToMany"===i.type){const e=p.tables[i.entity1],t=p.tables[i.entity2];e&&t&&(a=`    ${e.schemaName||i.entity1} }o--o{ ${t.schemaName||i.entity2} : "${i.schemaName}"`)}if(a&&"tablesonly"!==e)r+=a+"\n";else if(a&&"tablesonly"===e){("ManyToMany"===i.type?[i.entity1,i.entity2]:[i.referencedEntity,i.referencingEntity]).every((e=>p.tables[e]))&&(r+=a+"\n")}})),r},Te=()=>{m=!0,y=i,u=setInterval(f,500),z.disabled=!0,z.style.opacity="0.5",I.disabled=!1,I.style.opacity="1",O.style.display="block",T.style.display="block",oe("ðŸ”´ Recording active. Navigate to any table (via subgrid, lookup, or URL) - tables will be auto-captured!"),N("Recording started","info")},Me=()=>{m=!1,u&&(clearInterval(u),u=null),z.disabled=!1,z.style.opacity="1",I.disabled=!0,I.style.opacity="0.5",O.style.display="none",T.style.display="none",oe("â¸ Recording stopped. "+Object.keys(p.tables).length+" tables captured."),N("Recording stopped","info")};if(z.addEventListener("click",Te),I.addEventListener("click",Me),H.addEventListener("click",(async()=>{const e=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext(),t=e&&e.input&&e.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();t?(t!==i&&(i=t,P.textContent=t),await ke(t)):oe("No current table found to capture.",!0)})),F.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to export.");const e=document.querySelector('input[name="mermaidMode"]:checked').value,t=document.getElementById("hide-self-ref").checked,r={};Object.entries(p.tables).forEach((function(t){const i=t[0],a=t[1],n=we(a,e);r[i]={logicalName:a.logicalName,schemaName:a.schemaName,displayName:a.displayName,primaryIdAttribute:a.primaryIdAttribute,primaryNameAttribute:a.primaryNameAttribute,entitySetName:a.entitySetName,description:a.description,fields:n,customFields:a.customFields,relationshipsCount:a.relationshipsCount}}));const i=Le(p.relationships,e,r,t),n={tables:r,relationships:i,relatedTables:Array.from(p.relatedTables),config:{mermaidMode:e,hideSelfReferencing:t},exportedAt:(new Date).toISOString(),version:"1.3"},o=Object.values(r).reduce((function(e,t){return e+(t.fields?t.fields.length:0)}),0),d=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),l=URL.createObjectURL(d),s=a("a");s.href=l,s.download="erd-data-"+e+"-"+Date.now()+".json",s.click(),URL.revokeObjectURL(l),oe("âœ“ JSON exported: "+Object.keys(r).length+" tables, "+o+" fields, "+i.length+" relationships")})),B.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to export.");const e=document.querySelector('input[name="mermaidMode"]:checked').value,t=document.getElementById("hide-self-ref").checked,r=Oe(e,t),i="optimized"===e?"optimized":"tablesonly"===e?"tables":"full",n=new Blob([r],{type:"text/plain"}),o=URL.createObjectURL(n),d=a("a");d.href=o,d.download=`erd-diagram-${i}-${Date.now()}.mmd`,d.click(),URL.revokeObjectURL(o),oe(`âœ“ Mermaid ERD (${"optimized"===e?"Optimized":"tablesonly"===e?"Tables Only":"Complete"}) exported`)})),q.addEventListener("click",(()=>{confirm("Really delete all captured data?")&&(p={tables:{},relationships:[],relatedTables:new Set},N("Cleared all data","info"),me(),Ee(),Ne(),oe("All data cleared."))})),J.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to visualize. Capture some tables first.");const e=C(),r=window.__lvlUpOverlay.createOverlay("ERD Diagram Viewer",{width:1200,rootId:"erd-viewer-overlay"});if(!r)return;r.body.style.maxHeight="80vh",r.body.style.overflowY="auto";let i=document.getElementById("hide-self-ref").checked;const l=n(o(a("div"),`padding:40px;text-align:center;color:${e.textMuted};font-size:14px;`),"â³ Loading Mermaid renderer...");if(r.body.appendChild(l),window.mermaid)window.mermaid.initialize({startOnLoad:!1,theme:"dark"===t.host.getAttribute("data-theme")?"dark":"default",securityLevel:"loose"}),s();else{const i=a("script");i.src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js",i.onload=()=>{window.mermaid.initialize({startOnLoad:!1,theme:"dark"===t.host.getAttribute("data-theme")?"dark":"default",securityLevel:"loose"}),s()},i.onerror=()=>{d(r.body),r.body.appendChild(n(o(a("div"),`padding:40px;text-align:center;color:${e.textError};`),"âŒ Failed to load Mermaid library. Check your internet connection."))},document.head.appendChild(i)}function s(){d(r.body);const t=document.querySelector('input[name="mermaidMode"]:checked').value,l=Oe(t,i),c=o(a("div"),`padding:20px;background:${e.bg};border-radius:4px;min-height:400px;`),p=o(a("div"),`display:flex;gap:12px;align-items:center;margin-bottom:12px;padding:8px;background:${e.bgHover};border-radius:4px;`),m=a("input");m.type="checkbox",m.id="hide-self-ref-view",m.checked=i;const g=a("label");g.htmlFor="hide-self-ref-view",g.style.cssText=`font-size:12px;color:${e.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,g.appendChild(m),g.appendChild(document.createTextNode("ðŸ”„ Hide self-referencing relationships")),p.appendChild(g),m.addEventListener("change",(()=>{i=m.checked,s()})),c.appendChild(p);const y=a("div");y.className="mermaid",y.textContent=l,c.appendChild(y);const u=o(a("div"),`display:flex;gap:8px;margin-top:16px;padding:12px;background:${e.bgHover};border-radius:4px;`),b=n(a("button"),"ðŸ“‹ Copy Code");b.style.cssText=`flex:1;padding:8px 16px;background:${e.primary};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,b.onclick=()=>{navigator.clipboard.writeText(l).then((()=>alert("Mermaid code copied to clipboard!"))).catch((()=>alert("Failed to copy to clipboard")))};const x=n(a("button"),"ðŸ’¾ Download");x.style.cssText=`flex:1;padding:8px 16px;background:${e.success};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,x.onclick=()=>{const e=new Blob([l],{type:"text/plain"}),r=URL.createObjectURL(e),i=a("a");i.href=r,i.download=`erd-diagram-${t}-${Date.now()}.mmd`,i.click(),URL.revokeObjectURL(r)};const f=n(a("button"),"âœ– Close");f.style.cssText=`flex:1;padding:8px 16px;background:${e.textMuted};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,f.onclick=()=>r.closeOverlay(),u.appendChild(b),u.appendChild(x),u.appendChild(f),c.appendChild(u),r.body.appendChild(c);try{window.mermaid.run({nodes:[y]}),N("ERD diagram viewed","info")}catch(t){console.error(t),d(c),c.appendChild(n(o(a("div"),`padding:40px;text-align:center;color:${e.textError};`),"âŒ Error rendering diagram: "+t.message))}}})),D.addEventListener("click",(()=>{const e=a("input");e.type="file",e.accept=".json",e.onchange=async e=>{try{const t=e.target.files[0];if(!t)return;const r=await t.text(),i=JSON.parse(r);if(!i.tables||"object"!=typeof i.tables)return void alert("Invalid JSON format. Expected data with tables object.");p.tables=i.tables||{},p.relationships=i.relationships||[],p.relatedTables=new Set(i.relatedTables||[]);let a=!1;if(i.config){if(i.config.mermaidMode){const e=document.getElementById("mode-"+("optimized"===i.config.mermaidMode?"opt":"full"===i.config.mermaidMode?"full":"tablesonly"===i.config.mermaidMode?"tables":"custom"));e&&(e.checked=!0,a=!0)}if("boolean"==typeof i.config.hideSelfReferencing){const e=document.getElementById("hide-self-ref");e&&(e.checked=i.config.hideSelfReferencing,a=!0)}}else{if(Object.values(p.tables).some((e=>e.customFields&&Array.isArray(e.customFields)&&e.customFields.length>0))){const e=document.getElementById("mode-custom");e&&(e.checked=!0)}}N("Imported "+Object.keys(p.tables).length+" tables from JSON","info"),me(),Ee(),Ne(),oe("âœ“ Imported "+Object.keys(p.tables).length+" tables from JSON"+(a?" (config restored)":""))}catch(e){console.error(e),alert("Error importing JSON: "+e.message),N("Error importing JSON: "+e.message,"error")}},e.click()})),X.addEventListener("click",(()=>{const e=a("input");e.type="file",e.accept=".mmd,.mermaid,.txt",e.onchange=async e=>{try{const t=e.target.files[0];if(!t)return;const r=(await t.text()).split("\n");let i=0;r.forEach((e=>{const t=e.match(/^\s*(\w+)\s+\x7b/);if(t){const e=t[1];p.tables[e]||(p.tables[e]={logicalName:e,schemaName:e,displayName:e,fields:[],relationshipsCount:0},i++)}})),i>0?(N(`Imported ${i} tables from Mermaid diagram`,"info"),me(),Ee(),Ne(),oe(`âœ“ Imported ${i} table names from Mermaid. Capture them to get full details.`),alert(`Imported ${i} table names. Use "Capture Current Table" on each to get full field and relationship details.`)):(alert("No tables found in Mermaid file."),N("No tables found in Mermaid file","warning"))}catch(e){console.error(e),alert("Error importing Mermaid: "+e.message),N("Error importing Mermaid: "+e.message,"error")}},e.click()})),t.footer){const e=n(a("button"),String.fromCharCode(9881)+" Settings");e.style.cssText=`background:transparent;border:1px solid ${k.border};color:${k.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;`,e.onclick=function(){const e=window.__lvlUpOverlay.createOverlay("Settings",{width:500,rootId:"erd-settings-overlay"});if(!e)return;let r="dark"===t.host.getAttribute("data-theme")?"dark":"light";const i=C(),l=a("div"),s=o(a("div"),"display:flex;gap:8px;margin-bottom:16px;"),c=n(a("button"),"â˜€ï¸ Light Mode"),p=n(a("button"),"ðŸŒ™ Dark Mode"),m=e=>`flex:1;padding:8px 16px;border:none;background:${e?i.primary:i.bgHover};color:${e?i.textOnPrimary:i.text};border-radius:4px;cursor:pointer;font-weight:600;`;c.style.cssText=m("light"===r),p.style.cssText=m("dark"===r);const g=a("div"),y={},u={},b=e=>{d(g),y[e]={},u[e]={};const t=v&&v[e]||h[e];Object.keys(h[e]).forEach((r=>{const d=o(a("div"),"display:flex;align-items:center;gap:8px;margin-bottom:10px;"),l=n(o(a("label"),"flex:1;font-size:13px;color:"+i.text+";"),r),s=a("input");s.type="color",s.value=t[r],s.style.cssText="width:60px;height:32px;border:1px solid "+i.border+";border-radius:4px;cursor:pointer;",y[e][r]=s;const c=a("input");c.type="text",c.value=t[r],c.maxLength=7,c.placeholder="#000000",c.style.cssText="width:80px;padding:4px 8px;border:1px solid "+i.border+";border-radius:4px;font-family:monospace;font-size:12px;text-transform:uppercase;",u[e][r]=c;const p=o(a("div"),`width:40px;height:32px;background:${t[r]};border:1px solid ${i.border};border-radius:4px;`),m=e=>{/^#[0-9A-Fa-f]{6}$/.test(e)&&(s.value=e,c.value=e.toUpperCase(),p.style.background=e)};s.addEventListener("input",(()=>{m(s.value)})),c.addEventListener("input",(()=>{const e=c.value.trim();"#"!==e.charAt(0)&&e.length>0&&(c.value="#"+e),m(c.value)})),c.addEventListener("blur",(()=>{/^#[0-9A-Fa-f]{6}$/.test(c.value)||(c.value=s.value)})),d.appendChild(l),d.appendChild(s),d.appendChild(c),d.appendChild(p),g.appendChild(d)}))};b(r),c.onclick=()=>{r="light",c.style.cssText=m(!0),p.style.cssText=m(!1),b("light")},p.onclick=()=>{r="dark",c.style.cssText=m(!1),p.style.cssText=m(!0),b("dark")},s.appendChild(c),s.appendChild(p),l.appendChild(s),l.appendChild(g);const x=o(a("div"),"display:flex;gap:8px;margin-top:16px;"),f=n(a("button"),"ðŸ’¾ Save");f.style.cssText=`flex:1;padding:8px 16px;background:${i.primary};color:${i.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`;const E=n(a("button"),"ðŸ”„ Reset to Defaults");E.style.cssText=`flex:1;padding:8px 16px;background:${i.bgHover};color:${i.text};border:1px solid ${i.border};border-radius:4px;cursor:pointer;font-weight:600;`;const k=n(a("button"),"âœ– Cancel");k.style.cssText=`flex:1;padding:8px 16px;background:${i.bgHover};color:${i.text};border:1px solid ${i.border};border-radius:4px;cursor:pointer;font-weight:600;`,f.onclick=()=>{const r={light:{},dark:{}};["light","dark"].forEach((e=>{y[e]?Object.keys(y[e]).forEach((t=>{r[e][t]=y[e][t].value})):r[e]=v&&v[e]||h[e]}));try{localStorage.setItem("crmab-erdexplorer-colors",JSON.stringify(r)),v=r,N("Settings saved","info"),e.closeOverlay(),t.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error saving settings: "+e.message)}},E.onclick=()=>{if(confirm("Reset all color settings to defaults?"))try{localStorage.removeItem("crmab-erdexplorer-colors"),v=null,N("Settings reset to defaults","info"),e.closeOverlay(),t.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error resetting settings: "+e.message)}},k.onclick=()=>e.closeOverlay(),x.appendChild(f),x.appendChild(E),x.appendChild(k),l.appendChild(x),e.body.appendChild(l)};const r=n(a("button"),String.fromCharCode(128276)+" Logs");r.style.cssText=`background:transparent;border:1px solid ${k.border};color:${k.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;margin-left:8px;`,r.onclick=function e(){const t=C(),r=window.__lvlUpOverlay.createOverlay("Activity Logs",{width:600,rootId:"erd-logs-overlay"});if(!r)return;const i=a("div");0===E.length?i.appendChild(n(o(a("div"),`padding:20px;text-align:center;color:${t.textMuted};`),"No activity logged yet.")):E.slice().reverse().forEach((e=>{const r=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${t.borderLight};font-size:12px;color:${"error"===e.type?t.textError:t.textMuted};`),n=o(a("span"),"font-weight:600;margin-right:8px;");n.textContent=e.timestamp.toLocaleTimeString();const d=a("span");d.textContent=e.message,r.appendChild(n),r.appendChild(d),i.appendChild(r)}));const d=n(a("button"),"ðŸ—‘ Clear Logs");d.style.cssText=`width:100%;margin-top:12px;padding:8px;background:${t.danger};color:${t.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,d.onclick=()=>{confirm("Clear all logs?")&&(E=[],r.closeOverlay(),e())},i.appendChild(d),r.body.appendChild(i)},t.footer.insertBefore(e,t.footer.firstChild),t.footer.insertBefore(r,t.footer.children[1])}const Pe=t.closeOverlay;Pe&&(t.closeOverlay=function(){m=!1,u&&(clearInterval(u),u=null),Pe.call(t)}),i&&oe("Current table found. Ready to capture.")}catch(e){console.error(e);const r=getColors(),i=ce("div");i.style.cssText=`color:${r.textError};margin-top:8px;padding:8px;background:${r.bgError};border-radius:4px;`,i.textContent="Error: "+(e.message||e),t.body.appendChild(i)}}();