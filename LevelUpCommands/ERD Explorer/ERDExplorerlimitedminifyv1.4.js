!async function(){const{createOverlay:e}=window.__lvlUpOverlay||(alert("Overlay helpers not loaded"),{});if(!e)return;const t=e("ERD Explorer",{footer:!0});t.body&&(t.body.style.maxHeight="85vh",t.body.style.overflowY="auto",t.body.style.paddingBottom="20px",t.body.parentElement&&(t.body.parentElement.style.minWidth="700px",t.body.parentElement.style.maxWidth="900px",t.body.parentElement.style.maxHeight="90vh"));try{const e=Xrm.Utility.getGlobalContext(),r=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext();let i=r&&r.input&&r.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();const a=e=>document.createElement(e),n=(e,t)=>(e.textContent=t,e),o=(e,t)=>(e.style.cssText=t,e),d=e=>{for(;e.firstChild;)e.removeChild(e.firstChild)},s=()=>e.getClientUrl()+"/api/data/v9.2",l=()=>({"OData-MaxVersion":"4.0","OData-Version":"4.0",Accept:"application/json","Content-Type":"application/json"}),c=async e=>{const t=await fetch(s()+e,{headers:l()});if(!t.ok)throw new Error("HTTP "+t.status);return t.json()};let p={tables:{},relationships:[],relatedTables:new Set},m=!1,g=!1,y=null,u=window.location.href;const b=a("button");if(b.textContent="â”€",b.title="Minimize overlay",b.style.cssText="background:transparent;border:none;color:inherit;font-size:16px;cursor:pointer;padding:4px 8px;margin-right:4px;",t.header&&t.close){const e=a("div");e.style.cssText="display:flex;align-items:center;gap:4px;",t.header.removeChild(t.close),e.appendChild(b),e.appendChild(t.close),t.header.appendChild(e)}const h=()=>{g=!g,g?(t.body.style.display="none",t.footer&&(t.footer.style.display="none"),t.host.style.maxHeight="none",b.textContent="â–¡",b.title="Restore overlay"):(t.body.style.display="",t.footer&&(t.footer.style.display=""),t.host.style.maxHeight="90vh",b.textContent="â”€",b.title="Minimize overlay")};b.addEventListener("click",h);const x=async()=>{if(!m)return;const e=window.location.href;e!==u&&(u=e,await f())},f=async()=>{if(m)try{const e=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext(),t=e&&e.input&&e.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();t&&t!==y&&!p.tables[t]&&(y=t,i=t,R.textContent=t,de("ðŸ”´ Auto-capturing: "+t+"..."),await ke(t),N("Auto-captured table: "+t,"info"))}catch(e){console.error("Auto-recording check failed:",e)}},v={light:{primary:"#0078d4",primaryHover:"#106ebe",border:"#ddd",borderLight:"#eee",text:"#323130",textMuted:"#605e5c",textError:"#a80000",bg:"#fff",bgHover:"#f3f2f1",bgError:"#fde7e9",textOnPrimary:"#fff",success:"#107c10",successHover:"#0e6b0e",danger:"#d13438",dangerHover:"#a80000",warning:"#ff0000"},dark:{primary:"#60a5fa",primaryHover:"#3b82f6",border:"#374151",borderLight:"#4b5563",text:"#eef2ff",textMuted:"#9ca3af",textError:"#fca5a5",bg:"#1f2937",bgHover:"#374151",bgError:"#7f1d1d",textOnPrimary:"#fff",success:"#10b981",successHover:"#059669",danger:"#ef4444",dangerHover:"#dc2626",warning:"#f87171"}};let C=null;try{const e=localStorage.getItem("crmab-erdexplorer-colors");e&&(C=JSON.parse(e))}catch(e){}const w=()=>{const e="dark"===t.host.getAttribute("data-theme")?"dark":"light";return C&&C[e]||v[e]};let E=[];const N=(e,t)=>{E.push({timestamp:new Date,message:e,type:t||"info"}),E.length>100&&E.shift()},k=w(),$=o(a("div"),`margin:8px 0;padding:12px;background:${k.primary};color:${k.textOnPrimary};border-radius:4px;display:flex;justify-content:space-between;align-items:center;`),L=n(o(a("span"),"font-weight:600;font-size:14px;"),"ðŸ“Š ERD Auto-Documentation"),O=o(a("div"),"display:flex;align-items:center;gap:8px;"),T=o(a("div"),`width:12px;height:12px;border-radius:50%;background:${k.warning};display:none;animation:blink 1.5s infinite;`),M=n(o(a("span"),"font-size:12px;display:none;"),"â— RECORDING");if(O.appendChild(T),O.appendChild(M),$.appendChild(L),$.appendChild(O),t.body.appendChild($),!document.getElementById("erd-explorer-styles")){const e=a("style");e.id="erd-explorer-styles",e.textContent="@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }",document.head.appendChild(e)}const S=o(a("div"),`margin:8px 0 12px 0;padding:8px;background:${k.bgHover};border-radius:4px;border-left:4px solid ${k.primary};`);S.appendChild(document.createTextNode("Current Table: "));const R=n(a("b"),i||"None found");S.appendChild(R),t.body.appendChild(S);const P=o(a("div"),"display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;"),A=(e,t)=>{e.style.cssText=`background:${t?k.bg:k.bgHover};color:${k.text};border:1px solid ${k.border};padding:4px 10px;border-radius:3px;cursor:pointer;font-weight:500;font-size:12px;transition:all 0.2s;`,e.addEventListener("mouseenter",(function(){this.style.background=k.primaryHover,this.style.borderColor=k.textMuted})),e.addEventListener("mouseleave",(function(){this.style.background=t?k.bg:k.bgHover,this.style.borderColor=k.border}))},z=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),I=n(a("button"),"â–¶ Start");A(I);const H=n(a("button"),"â¸ Stop");A(H),H.disabled=!0,H.style.opacity="0.5";const j=n(a("button"),"ðŸ“¸ Capture");A(j),z.appendChild(I),z.appendChild(H),z.appendChild(j);const D=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),F=n(a("button"),"â†‘ Import JSON");A(F);const U=n(a("button"),"â†“ Export JSON");A(U),D.appendChild(F),D.appendChild(U);const _=o(a("div"),`display:flex;gap:4px;padding:6px;background:${k.bgHover};border-radius:4px;border:1px solid ${k.borderLight};`),X=n(a("button"),"â†‘ Import ERD");A(X);const B=n(a("button"),"â†“ Export ERD");A(B);const J=n(a("button"),"ðŸ‘ View ERD");A(J),_.appendChild(X),_.appendChild(B),_.appendChild(J);const q=o(a("div"),"padding:6px;"),V=n(a("button"),"ðŸ—‘ Clear");A(V,!0),q.appendChild(V),P.appendChild(z),P.appendChild(D),P.appendChild(_),P.appendChild(q),t.body.appendChild(P);const K=o(a("div"),`margin:8px 0;padding:10px;background:${k.bgHover};border-radius:4px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;`),W=n(o(a("span"),`font-weight:600;font-size:12px;color:${k.text};`),"Mermaid ERD Mode:"),Y=a("input");Y.type="radio",Y.name="mermaidMode",Y.value="optimized",Y.id="mode-opt",Y.checked=!0;const G=a("label");G.htmlFor="mode-opt",G.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,G.appendChild(Y),G.appendChild(document.createTextNode("ðŸŽ¯ Optimized (Primary, Keys, Lookups)"));const Q=a("input");Q.type="radio",Q.name="mermaidMode",Q.value="full",Q.id="mode-full";const Z=a("label");Z.htmlFor="mode-full",Z.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,Z.appendChild(Q),Z.appendChild(document.createTextNode("ðŸ“‹ Complete (all fields)"));const ee=a("input");ee.type="radio",ee.name="mermaidMode",ee.value="tablesonly",ee.id="mode-tables";const te=a("label");te.htmlFor="mode-tables",te.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,te.appendChild(ee),te.appendChild(document.createTextNode("ðŸ“¦ Tables Only (no fields)"));const re=a("input");re.type="radio",re.name="mermaidMode",re.value="custom",re.id="mode-custom";const ie=a("label");ie.htmlFor="mode-custom",ie.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,ie.appendChild(re),ie.appendChild(document.createTextNode("âœï¸ Custom (per-table selection)")),K.appendChild(W),K.appendChild(G),K.appendChild(Z),K.appendChild(te),K.appendChild(ie);const ae=a("input");ae.type="checkbox",ae.id="hide-self-ref",ae.style.cssText="margin-left:16px;";const ne=a("label");ne.htmlFor="hide-self-ref",ne.style.cssText=`font-size:12px;color:${k.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,ne.appendChild(ae),ne.appendChild(document.createTextNode("ðŸ”„ Hide self-referencing")),K.appendChild(ne),t.body.appendChild(K);const oe=o(a("div"),`margin:8px 0;padding:8px;background:${k.bg};border:1px solid ${k.border};border-radius:4px;font-size:12px;color:${k.textMuted};`);oe.textContent='Ready. Click "Start Recording" or capture the current table.',t.body.appendChild(oe);const de=(e,t)=>{oe.textContent=e,oe.style.color=t?k.textError:k.textMuted,oe.style.background=t?k.bgError:k.bg,e&&N(e,t?"error":"info")},se=o(a("div"),`margin:12px 0;padding:12px;background:${k.bg};border:1px solid ${k.border};border-radius:4px;display:flex;gap:16px;justify-content:space-around;flex-wrap:wrap;`),le=(e,t)=>{const r=o(a("div"),"flex:1;min-width:120px;text-align:center;");return r.appendChild(n(o(a("div"),`font-size:24px;font-weight:600;color:${k.primary};`),t)),r.appendChild(n(o(a("div"),`font-size:11px;color:${k.textMuted};text-transform:uppercase;margin-top:4px;`),e)),r},ce=le("Tables","0"),pe=le("Relationships","0"),me=le("Fields","0");se.appendChild(ce),se.appendChild(pe),se.appendChild(me),t.body.appendChild(se);const ge=()=>{const e=Object.keys(p.tables).length,t=p.relationships.length,r=Object.values(p.tables).reduce(((e,t)=>e+(t.fields?t.fields.length:0)),0);ce.firstChild.textContent=e,pe.firstChild.textContent=t,me.firstChild.textContent=r},ye=n(o(a("div"),`font-weight:600;margin:16px 0 8px 0;padding:8px 0;border-bottom:2px solid ${k.primary};`),"Captured Tables");t.body.appendChild(ye);const ue=o(a("div"),`border:1px solid ${k.border};border-radius:4px;max-height:300px;overflow-y:auto;background:${k.bg};`),be=n(o(a("div"),`padding:20px;text-align:center;color:${k.textMuted};`),"No tables captured yet.");ue.appendChild(be),t.body.appendChild(ue);const he=n(o(a("div"),`font-weight:600;margin:16px 0 8px 0;padding:8px 0;border-bottom:2px solid ${k.success};`),"Related Tables (found via Relationships)");t.body.appendChild(he);const xe=o(a("div"),`padding:8px;background:${k.bgHover};border:1px solid ${k.border};border-bottom:none;border-radius:4px 4px 0 0;`),fe=a("input");fe.type="text",fe.placeholder="ðŸ” Search related tables...",fe.style.cssText=`width:100%;padding:6px 10px;border:1px solid ${k.border};border-radius:3px;font-size:12px;box-sizing:border-box;background:${k.bg};color:${k.text};`,xe.appendChild(fe),t.body.appendChild(xe);const ve=o(a("div"),`border:1px solid ${k.border};border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;background:${k.bg};`),Ce=n(o(a("div"),`padding:16px;text-align:center;color:${k.textMuted};font-size:11px;`),"No related tables found yet. Capture a table to see relationships.");ve.appendChild(Ce),t.body.appendChild(ve);const we=e=>{const t=w(),r=window.__lvlUpOverlay.createOverlay("Select Fields: "+(e.displayName||e.logicalName),{width:600,rootId:"erd-fields-overlay-"+e.logicalName});if(!r)return;r.host&&(r.host.style.zIndex="9999990"),r.body.style.maxHeight="70vh",r.body.style.overflowY="auto";const i=document.querySelector('input[name="mermaidMode"]:checked').value;let s=new Set;if(e.customFields&&Array.isArray(e.customFields))e.customFields.forEach((e=>s.add(e)));else if("full"===i)(e.fields||[]).forEach((e=>s.add(e.logicalName)));else if("optimized"===i){const t=new Set;p.relationships.forEach((r=>{r.referencingEntity===e.logicalName&&r.referencingAttribute&&t.add(r.referencingAttribute.toLowerCase()),r.referencedEntity===e.logicalName&&r.referencedAttribute&&t.add(r.referencedAttribute.toLowerCase())})),(e.fields||[]).filter((e=>{const r=e.logicalName.toLowerCase();return e.isPrimaryId||e.isPrimaryName||t.has(r)})).forEach((e=>s.add(e.logicalName)))}const l=o(a("div"),`padding:12px;background:${t.bgHover};border-radius:4px;margin-bottom:12px;`),c=a("input");c.type="text",c.placeholder="ðŸ” Filter fields...",c.style.cssText=`width:100%;padding:8px 12px;border:1px solid ${t.border};border-radius:4px;font-size:13px;box-sizing:border-box;background:${t.bg};color:${t.text};margin-bottom:8px;`,l.appendChild(c);const m=o(a("div"),`font-size:12px;color:${t.textMuted};display:flex;justify-content:space-between;align-items:center;`),g=a("span");g.textContent=s.size+" of "+(e.fields?e.fields.length:0)+" fields selected";const y=o(a("div"),"display:flex;gap:8px;"),u=n(a("button"),"Select All");u.style.cssText=`padding:4px 8px;font-size:11px;background:${t.bg};border:1px solid ${t.border};border-radius:3px;cursor:pointer;color:${t.text};`;const b=n(a("button"),"Select None");b.style.cssText=`padding:4px 8px;font-size:11px;background:${t.bg};border:1px solid ${t.border};border-radius:3px;cursor:pointer;color:${t.text};`,y.appendChild(u),y.appendChild(b),m.appendChild(g),m.appendChild(y),l.appendChild(m),r.body.appendChild(l);const h=o(a("div"),`border:1px solid ${t.border};border-radius:4px;max-height:400px;overflow-y:auto;background:${t.bg};`),x=()=>{g.textContent=s.size+" of "+(e.fields?e.fields.length:0)+" fields selected"},f=r=>{d(h);const i=(r||"").toLowerCase(),l=(e.fields||[]).slice().sort(((e,t)=>e.isPrimaryId&&!t.isPrimaryId?-1:!e.isPrimaryId&&t.isPrimaryId?1:e.isPrimaryName&&!t.isPrimaryName?-1:!e.isPrimaryName&&t.isPrimaryName?1:e.logicalName.localeCompare(t.logicalName)));let c=0;if(l.forEach((e=>{if(!(!i||-1!==e.logicalName.toLowerCase().indexOf(i)||e.displayName&&-1!==e.displayName.toLowerCase().indexOf(i)||-1!==e.type.toLowerCase().indexOf(i)))return;c++;const r=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${t.borderLight};display:flex;align-items:center;gap:10px;cursor:pointer;`);r.addEventListener("mouseenter",(function(){this.style.background=t.bgHover})),r.addEventListener("mouseleave",(function(){this.style.background=s.has(e.logicalName)?t.bgHover:""})),s.has(e.logicalName)&&(r.style.background=t.bgHover);const d=a("input");d.type="checkbox",d.checked=s.has(e.logicalName),d.style.cssText="width:16px;height:16px;cursor:pointer;flex-shrink:0;";const l=a("div");l.style.flex="1";const p=o(a("div"),`font-weight:500;color:${t.text};font-size:13px;`);if(p.textContent=e.logicalName,e.isPrimaryId){const e=n(o(a("span"),`margin-left:6px;padding:1px 5px;background:${t.primary};color:${t.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"PK");p.appendChild(e)}if(e.isPrimaryName){const e=n(o(a("span"),`margin-left:6px;padding:1px 5px;background:${t.success};color:${t.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"NAME");p.appendChild(e)}const m=o(a("div"),`font-size:11px;color:${t.textMuted};margin-top:2px;`);m.textContent=(e.displayName||"")+" â€¢ "+e.type,l.appendChild(p),l.appendChild(m);const g=n(o(a("span"),`font-size:11px;color:${t.textMuted};background:${t.bgHover};padding:2px 6px;border-radius:3px;flex-shrink:0;`),e.type);r.addEventListener("click",(i=>{i.target!==d&&(s.has(e.logicalName)?(s.delete(e.logicalName),d.checked=!1,r.style.background=""):(s.add(e.logicalName),d.checked=!0,r.style.background=t.bgHover),x())})),d.addEventListener("change",(()=>{d.checked?(s.add(e.logicalName),r.style.background=t.bgHover):(s.delete(e.logicalName),r.style.background=""),x()})),r.appendChild(d),r.appendChild(l),r.appendChild(g),h.appendChild(r)})),0===c){const e=n(o(a("div"),`padding:20px;text-align:center;color:${t.textMuted};`),"No fields match the filter.");h.appendChild(e)}};f(""),r.body.appendChild(h),c.addEventListener("input",(function(){f(this.value)})),u.addEventListener("click",(()=>{(e.fields||[]).forEach((e=>s.add(e.logicalName))),x(),f(c.value)})),b.addEventListener("click",(()=>{s.clear(),x(),f(c.value)}));const v=o(a("div"),`display:flex;gap:8px;margin-top:16px;padding-top:12px;border-top:1px solid ${t.border};`),C=n(a("button"),"ðŸ’¾ Save Selection");C.style.cssText=`flex:1;padding:10px 16px;background:${t.primary};color:${t.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;`,C.addEventListener("mouseenter",(function(){this.style.background=t.primaryHover})),C.addEventListener("mouseleave",(function(){this.style.background=t.primary}));const E=n(a("button"),"âœ– Cancel");E.style.cssText=`flex:1;padding:10px 16px;background:${t.bgHover};color:${t.text};border:1px solid ${t.border};border-radius:4px;cursor:pointer;font-weight:600;font-size:13px;`,C.addEventListener("click",(()=>{e.customFields=Array.from(s);const t=document.getElementById("mode-custom");t&&(t.checked=!0),N("Custom fields saved for "+e.logicalName+" ("+s.size+" fields)","info"),de("âœ“ Custom field selection saved for "+(e.displayName||e.logicalName)),Ee(),r.closeOverlay()})),E.addEventListener("click",(()=>{r.closeOverlay()})),v.appendChild(C),v.appendChild(E),r.body.appendChild(v)},Ee=()=>{d(ue);const e=Object.values(p.tables);0!==e.length?e.forEach((e=>{const t=o(a("div"),`padding:10px 12px;border-bottom:1px solid ${k.borderLight};display:flex;justify-content:space-between;align-items:center;`);t.addEventListener("mouseenter",(function(){this.style.background=k.bgHover})),t.addEventListener("mouseleave",(function(){this.style.background=""}));const r=a("div");r.style.flex="1";const i=o(a("div"),`font-weight:600;color:${k.text};margin-bottom:4px;`);if(i.textContent=e.displayName||e.logicalName,e.customFields&&Array.isArray(e.customFields)){const t=n(o(a("span"),`margin-left:8px;padding:2px 6px;background:${k.primary};color:${k.textOnPrimary};border-radius:3px;font-size:10px;font-weight:600;`),"CUSTOM: "+e.customFields.length);i.appendChild(t)}const d=o(a("div"),`font-size:11px;color:${k.textMuted};`);d.textContent=e.logicalName+" â€¢ "+(e.fields?e.fields.length:0)+" Fields â€¢ "+(e.relationshipsCount||0)+" Relationships",r.appendChild(i),r.appendChild(d);const s=o(a("div"),"display:flex;gap:6px;"),l=n(a("button"),"ðŸ“‹ Fields");l.style.cssText="background:"+k.primary+";color:"+k.textOnPrimary+";border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;",l.title="Select fields for ERD",l.addEventListener("mouseenter",(function(){this.style.background=k.primaryHover})),l.addEventListener("mouseleave",(function(){this.style.background=k.primary})),l.addEventListener("click",(t=>{t.stopPropagation(),we(e)}));const c=n(a("button"),"ðŸ—‘");c.style.cssText="background:"+k.danger+";color:"+k.textOnPrimary+";border:none;padding:4px 10px;border-radius:3px;cursor:pointer;font-size:14px;",c.title="Remove table",c.addEventListener("mouseenter",(function(){this.style.background=k.dangerHover})),c.addEventListener("mouseleave",(function(){this.style.background=k.danger})),c.addEventListener("click",(t=>{t.stopPropagation(),confirm('Remove table "'+(e.displayName||e.logicalName)+'"?')&&(delete p.tables[e.logicalName],p.relationships=p.relationships.filter((t=>t.referencedEntity!==e.logicalName&&t.referencingEntity!==e.logicalName&&t.entity1!==e.logicalName&&t.entity2!==e.logicalName)),N("Removed table: "+e.logicalName,"info"),ge(),Ee(),Ne())})),s.appendChild(l),s.appendChild(c),t.appendChild(r),t.appendChild(s),ue.appendChild(t)})):ue.appendChild(n(o(a("div"),`padding:20px;text-align:center;color:${k.textMuted};`),"No tables captured yet."))},Ne=()=>{d(ve);const e=Array.from(p.relatedTables).filter((e=>!p.tables[e])).sort(((e,t)=>e.localeCompare(t)));0!==e.length?e.forEach((e=>{const t=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${k.borderLight};display:flex;justify-content:space-between;align-items:center;`);t.setAttribute("data-table-name",e.toLowerCase()),t.addEventListener("mouseenter",(function(){this.style.background=k.bgHover})),t.addEventListener("mouseleave",(function(){this.style.background=""}));const r=o(a("div"),`font-weight:600;color:${k.text};font-size:12px;`);r.textContent=e;const i=n(a("button"),"+ Add");i.style.cssText="background:"+k.success+";color:"+k.textOnPrimary+";border:none;padding:4px 12px;border-radius:3px;cursor:pointer;font-size:11px;font-weight:600;",i.addEventListener("mouseenter",(function(){this.style.background=k.successHover})),i.addEventListener("mouseleave",(function(){this.style.background=k.success})),i.addEventListener("click",(async t=>{t.stopPropagation(),await ke(e)})),t.appendChild(r),t.appendChild(i),ve.appendChild(t)})):ve.appendChild(n(o(a("div"),`padding:16px;text-align:center;color:${k.textMuted};font-size:11px;`),0===e.length&&Object.keys(p.tables).length>0?"All related tables already captured.":"No related tables found yet."))};fe.addEventListener("input",(function(){const e=this.value.toLowerCase();Array.from(ve.children).forEach((t=>{const r=t.getAttribute("data-table-name");r&&(t.style.display=r.includes(e)?"":"none")}))}));const ke=async e=>{if(!e)return de("No valid table specified.",!0),null;de(`Analyzing table: ${e}...`);const t=String.fromCharCode(39);try{const r=await c(`/EntityDefinitions(LogicalName=${encodeURIComponent(t+e+t)})?$select=LogicalName,SchemaName,DisplayName,PrimaryIdAttribute,PrimaryNameAttribute,EntitySetName,Description&$expand=Attributes($select=LogicalName,AttributeType,DisplayName,Description,IsPrimaryId,IsPrimaryName;$filter=IsValidForRead eq true),OneToManyRelationships($select=SchemaName,ReferencedEntity,ReferencedAttribute,ReferencingEntity,ReferencingAttribute),ManyToOneRelationships($select=SchemaName,ReferencedEntity,ReferencedAttribute,ReferencingEntity,ReferencingAttribute),ManyToManyRelationships($select=SchemaName,Entity1LogicalName,Entity2LogicalName,IntersectEntityName)`),i={logicalName:r.LogicalName,schemaName:r.SchemaName,displayName:r.DisplayName?.UserLocalizedLabel?.Label||r.LogicalName,primaryIdAttribute:r.PrimaryIdAttribute,primaryNameAttribute:r.PrimaryNameAttribute,entitySetName:r.EntitySetName,description:r.Description?.UserLocalizedLabel?.Label||"",fields:[],relationshipsCount:0};r.Attributes&&r.Attributes.forEach((e=>{const t={logicalName:e.LogicalName,type:$e(e.AttributeType),displayName:e.DisplayName?.UserLocalizedLabel?.Label||e.LogicalName,description:e.Description?.UserLocalizedLabel?.Label||"",isPrimaryId:e.IsPrimaryId||!1,isPrimaryName:e.IsPrimaryName||!1};i.fields.push(t)}));const a=(t,r)=>{if(!t)return 0;let i=0;return t.forEach((t=>{const a={schemaName:t.SchemaName,type:r,referencedEntity:t.ReferencedEntity,referencedAttribute:t.ReferencedAttribute,referencingEntity:t.ReferencingEntity,referencingAttribute:t.ReferencingAttribute};p.relationships.some((e=>e.schemaName===a.schemaName))||(p.relationships.push(a),i++);const n="OneToMany"===r?t.ReferencingEntity:t.ReferencedEntity;n&&n!==e&&p.relatedTables.add(n)})),i};let n=0;return r.OneToManyRelationships&&(n+=a(r.OneToManyRelationships,"OneToMany")),r.ManyToOneRelationships&&(n+=a(r.ManyToOneRelationships,"ManyToOne")),r.ManyToManyRelationships&&r.ManyToManyRelationships.forEach((t=>{const r={schemaName:t.SchemaName,type:"ManyToMany",entity1:t.Entity1LogicalName,entity2:t.Entity2LogicalName,intersectEntity:t.IntersectEntityName};p.relationships.some((e=>e.schemaName===r.schemaName))||(p.relationships.push(r),n++),t.Entity1LogicalName!==e&&p.relatedTables.add(t.Entity1LogicalName),t.Entity2LogicalName!==e&&p.relatedTables.add(t.Entity2LogicalName)})),i.relationshipsCount=n,p.tables[e]?p.tables[e]={...p.tables[e],...i}:p.tables[e]=i,de(`âœ“ Table "${i.displayName}" captured: ${i.fields.length} Fields, ${n} new Relationships`),ge(),Ee(),Ne(),i}catch(t){return console.error(t),de(`Error analyzing ${e}: ${t.message}`,!0),null}},$e=e=>({String:"string",Memo:"memo",Integer:"int",BigInt:"bigint",Decimal:"decimal",Double:"float",Money:"money",Boolean:"boolean",DateTime:"datetime",Lookup:"lookup",Customer:"lookup",Owner:"lookup",Uniqueidentifier:"guid",Picklist:"picklist",State:"state",Status:"status",Virtual:"virtual",ManagedProperty:"managedproperty",EntityName:"entityname"}[e]||e.toLowerCase()),Le=(e,t)=>{if("tablesonly"===t)return[];if("custom"===t){if(e.customFields&&Array.isArray(e.customFields)&&e.customFields.length>0){const t=new Set(e.customFields);return(e.fields||[]).filter((e=>t.has(e.logicalName)))}return[]}if("optimized"===t){const t=new Set;return p.relationships.forEach((r=>{r.referencingEntity===e.logicalName&&r.referencingAttribute&&t.add(r.referencingAttribute.toLowerCase()),r.referencedEntity===e.logicalName&&r.referencedAttribute&&t.add(r.referencedAttribute.toLowerCase())})),(e.fields||[]).filter((e=>{const r=e.logicalName.toLowerCase();return e.isPrimaryId||e.isPrimaryName||t.has(r)}))}return e.fields||[]},Oe=(e,t,r,i)=>{const a=new Set(Object.keys(r));let n=e;if(i&&(n=n.filter((e=>!("ManyToMany"===e.type&&e.entity1===e.entity2||"ManyToMany"!==e.type&&e.referencedEntity===e.referencingEntity)))),"full"===t)return n.filter((e=>"ManyToMany"===e.type?a.has(e.entity1)&&a.has(e.entity2):a.has(e.referencedEntity)&&a.has(e.referencingEntity)));if("tablesonly"===t)return n.filter((e=>"ManyToMany"===e.type?a.has(e.entity1)&&a.has(e.entity2):a.has(e.referencedEntity)&&a.has(e.referencingEntity)));if("optimized"===t){const e=new Set;return Object.values(r).forEach((t=>{(t.fields||[]).forEach((r=>{e.add(t.logicalName+"."+r.logicalName.toLowerCase())}))})),n.filter((t=>{if("ManyToMany"===t.type)return a.has(t.entity1)&&a.has(t.entity2);if(!(a.has(t.referencedEntity)&&a.has(t.referencingEntity)))return!1;const r=t.referencedEntity+"."+(t.referencedAttribute||"").toLowerCase(),i=t.referencingEntity+"."+(t.referencingAttribute||"").toLowerCase();return e.has(r)||e.has(i)}))}if("custom"===t){const e=new Set;return Object.values(r).forEach((t=>{(t.fields||[]).forEach((r=>{e.add(t.logicalName+"."+r.logicalName.toLowerCase())}))})),n.filter((t=>{if("ManyToMany"===t.type)return a.has(t.entity1)&&a.has(t.entity2);if(!(a.has(t.referencedEntity)&&a.has(t.referencingEntity)))return!1;const r=t.referencedEntity+"."+(t.referencedAttribute||"").toLowerCase(),i=t.referencingEntity+"."+(t.referencingAttribute||"").toLowerCase();return e.has(r)||e.has(i)}))}return n},Te=(e,t)=>{let r="erDiagram\n";return Object.values(p.tables).forEach((t=>{r+=`    ${t.schemaName||t.logicalName} {\n`;Le(t,e).forEach((e=>{let t=`        ${e.type} ${e.logicalName}`;e.isPrimaryId&&(t+=" PK"),e.logicalName.endsWith("id")&&!e.isPrimaryId&&(t+=" FK"),e.displayName&&(t+=` "${e.displayName}"`),r+=t+"\n"})),r+="    }\n\n"})),p.relationships.forEach((i=>{if(t){if("ManyToMany"===i.type&&i.entity1===i.entity2||"ManyToMany"!==i.type&&i.referencedEntity===i.referencingEntity)return}let a="";if("OneToMany"===i.type){const e=p.tables[i.referencedEntity],t=p.tables[i.referencingEntity];e&&t&&(a=`    ${e.schemaName||i.referencedEntity} ||--o{ ${t.schemaName||i.referencingEntity} : "${i.schemaName}"`)}else if("ManyToOne"===i.type){const e=p.tables[i.referencedEntity],t=p.tables[i.referencingEntity];e&&t&&(a=`    ${t.schemaName||i.referencingEntity} }o--|| ${e.schemaName||i.referencedEntity} : "${i.schemaName}"`)}else if("ManyToMany"===i.type){const e=p.tables[i.entity1],t=p.tables[i.entity2];e&&t&&(a=`    ${e.schemaName||i.entity1} }o--o{ ${t.schemaName||i.entity2} : "${i.schemaName}"`)}if(a&&"tablesonly"!==e)r+=a+"\n";else if(a&&"tablesonly"===e){("ManyToMany"===i.type?[i.entity1,i.entity2]:[i.referencedEntity,i.referencingEntity]).every((e=>p.tables[e]))&&(r+=a+"\n")}})),r},Me=async()=>{m=!0,y=null,u=window.location.href,I.disabled=!0,I.style.opacity="0.5",H.disabled=!1,H.style.opacity="1",T.style.display="block",M.style.display="block",window.addEventListener("popstate",x),window.addEventListener("hashchange",x);const e=history.pushState,t=history.replaceState;history.pushState=function(){e.apply(this,arguments),x()},history.replaceState=function(){t.apply(this,arguments),x()},window._erdOrigPushState=e,window._erdOrigReplaceState=t,de("ðŸ”´ Recording active. Navigate via URL changes - tables will be auto-captured. (Note: subgrid/lookup clicks require manual Capture)"),N("Recording started (URL-based)","info"),await f()},Se=()=>{m=!1,window.removeEventListener("popstate",x),window.removeEventListener("hashchange",x),window._erdOrigPushState&&(history.pushState=window._erdOrigPushState,delete window._erdOrigPushState),window._erdOrigReplaceState&&(history.replaceState=window._erdOrigReplaceState,delete window._erdOrigReplaceState),I.disabled=!1,I.style.opacity="1",H.disabled=!0,H.style.opacity="0.5",T.style.display="none",M.style.display="none",de("â¸ Recording stopped. "+Object.keys(p.tables).length+" tables captured."),N("Recording stopped","info")};if(I.addEventListener("click",Me),H.addEventListener("click",Se),j.addEventListener("click",(async()=>{const e=Xrm.Utility.getPageContext&&Xrm.Utility.getPageContext(),t=e&&e.input&&e.input.entityName||Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName&&Xrm.Page.data.entity.getEntityName();t?(t!==i&&(i=t,R.textContent=t),await ke(t)):de("No current table found to capture.",!0)})),U.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to export.");const e=document.querySelector('input[name="mermaidMode"]:checked').value,t=document.getElementById("hide-self-ref").checked,r={};Object.entries(p.tables).forEach((function(t){const i=t[0],a=t[1],n=Le(a,e);r[i]={logicalName:a.logicalName,schemaName:a.schemaName,displayName:a.displayName,primaryIdAttribute:a.primaryIdAttribute,primaryNameAttribute:a.primaryNameAttribute,entitySetName:a.entitySetName,description:a.description,fields:n,customFields:a.customFields,relationshipsCount:a.relationshipsCount}}));const i=Oe(p.relationships,e,r,t),n={tables:r,relationships:i,relatedTables:Array.from(p.relatedTables),config:{mermaidMode:e,hideSelfReferencing:t},exportedAt:(new Date).toISOString(),version:"1.3"},o=Object.values(r).reduce((function(e,t){return e+(t.fields?t.fields.length:0)}),0),d=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),s=URL.createObjectURL(d),l=a("a");l.href=s,l.download="erd-data-"+e+"-"+Date.now()+".json",l.click(),URL.revokeObjectURL(s),de("âœ“ JSON exported: "+Object.keys(r).length+" tables, "+o+" fields, "+i.length+" relationships")})),B.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to export.");const e=document.querySelector('input[name="mermaidMode"]:checked').value,t=document.getElementById("hide-self-ref").checked,r=Te(e,t),i="optimized"===e?"optimized":"tablesonly"===e?"tables":"full",n=new Blob([r],{type:"text/plain"}),o=URL.createObjectURL(n),d=a("a");d.href=o,d.download=`erd-diagram-${i}-${Date.now()}.mmd`,d.click(),URL.revokeObjectURL(o),de(`âœ“ Mermaid ERD (${"optimized"===e?"Optimized":"tablesonly"===e?"Tables Only":"Complete"}) exported`)})),V.addEventListener("click",(()=>{confirm("Really delete all captured data?")&&(p={tables:{},relationships:[],relatedTables:new Set},N("Cleared all data","info"),ge(),Ee(),Ne(),de("All data cleared."))})),J.addEventListener("click",(()=>{if(0===Object.keys(p.tables).length)return void alert("No data to visualize. Capture some tables first.");const e=w(),r=window.__lvlUpOverlay.createOverlay("ERD Diagram Viewer",{width:1200,rootId:"erd-viewer-overlay"});if(!r)return;r.body.style.maxHeight="80vh",r.body.style.overflowY="auto";let i=document.getElementById("hide-self-ref").checked;const s=n(o(a("div"),`padding:40px;text-align:center;color:${e.textMuted};font-size:14px;`),"â³ Loading Mermaid renderer...");if(r.body.appendChild(s),window.mermaid)window.mermaid.initialize({startOnLoad:!1,theme:"dark"===t.host.getAttribute("data-theme")?"dark":"default",securityLevel:"loose"}),l();else{const i=a("script");i.src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js",i.onload=()=>{window.mermaid.initialize({startOnLoad:!1,theme:"dark"===t.host.getAttribute("data-theme")?"dark":"default",securityLevel:"loose"}),l()},i.onerror=()=>{d(r.body),r.body.appendChild(n(o(a("div"),`padding:40px;text-align:center;color:${e.textError};`),"âŒ Failed to load Mermaid library. Check your internet connection."))},document.head.appendChild(i)}function l(){d(r.body);const t=document.querySelector('input[name="mermaidMode"]:checked').value,s=Te(t,i),c=o(a("div"),`padding:20px;background:${e.bg};border-radius:4px;min-height:400px;`),p=o(a("div"),`display:flex;gap:12px;align-items:center;margin-bottom:12px;padding:8px;background:${e.bgHover};border-radius:4px;`),m=a("input");m.type="checkbox",m.id="hide-self-ref-view",m.checked=i;const g=a("label");g.htmlFor="hide-self-ref-view",g.style.cssText=`font-size:12px;color:${e.text};cursor:pointer;display:flex;align-items:center;gap:4px;`,g.appendChild(m),g.appendChild(document.createTextNode("ðŸ”„ Hide self-referencing relationships")),p.appendChild(g),m.addEventListener("change",(()=>{i=m.checked,l()})),c.appendChild(p);const y=a("div");y.className="mermaid",y.textContent=s,c.appendChild(y);const u=o(a("div"),`display:flex;gap:8px;margin-top:16px;padding:12px;background:${e.bgHover};border-radius:4px;`),b=n(a("button"),"ðŸ“‹ Copy Code");b.style.cssText=`flex:1;padding:8px 16px;background:${e.primary};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,b.onclick=()=>{navigator.clipboard.writeText(s).then((()=>alert("Mermaid code copied to clipboard!"))).catch((()=>alert("Failed to copy to clipboard")))};const h=n(a("button"),"ðŸ’¾ Download");h.style.cssText=`flex:1;padding:8px 16px;background:${e.success};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,h.onclick=()=>{const e=new Blob([s],{type:"text/plain"}),r=URL.createObjectURL(e),i=a("a");i.href=r,i.download=`erd-diagram-${t}-${Date.now()}.mmd`,i.click(),URL.revokeObjectURL(r)};const x=n(a("button"),"âœ– Close");x.style.cssText=`flex:1;padding:8px 16px;background:${e.textMuted};color:${e.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,x.onclick=()=>r.closeOverlay(),u.appendChild(b),u.appendChild(h),u.appendChild(x),c.appendChild(u),r.body.appendChild(c);try{window.mermaid.run({nodes:[y]}),N("ERD diagram viewed","info")}catch(t){console.error(t),d(c),c.appendChild(n(o(a("div"),`padding:40px;text-align:center;color:${e.textError};`),"âŒ Error rendering diagram: "+t.message))}}})),F.addEventListener("click",(()=>{const e=a("input");e.type="file",e.accept=".json",e.onchange=async e=>{try{const t=e.target.files[0];if(!t)return;const r=await t.text(),i=JSON.parse(r);if(!i.tables||"object"!=typeof i.tables)return void alert("Invalid JSON format. Expected data with tables object.");p.tables=i.tables||{},p.relationships=i.relationships||[],p.relatedTables=new Set(i.relatedTables||[]);let a=!1;if(i.config){if(i.config.mermaidMode){const e=document.getElementById("mode-"+("optimized"===i.config.mermaidMode?"opt":"full"===i.config.mermaidMode?"full":"tablesonly"===i.config.mermaidMode?"tables":"custom"));e&&(e.checked=!0,a=!0)}if("boolean"==typeof i.config.hideSelfReferencing){const e=document.getElementById("hide-self-ref");e&&(e.checked=i.config.hideSelfReferencing,a=!0)}}else{if(Object.values(p.tables).some((e=>e.customFields&&Array.isArray(e.customFields)&&e.customFields.length>0))){const e=document.getElementById("mode-custom");e&&(e.checked=!0)}}N("Imported "+Object.keys(p.tables).length+" tables from JSON","info"),ge(),Ee(),Ne(),de("âœ“ Imported "+Object.keys(p.tables).length+" tables from JSON"+(a?" (config restored)":""))}catch(e){console.error(e),alert("Error importing JSON: "+e.message),N("Error importing JSON: "+e.message,"error")}},e.click()})),X.addEventListener("click",(()=>{const e=a("input");e.type="file",e.accept=".mmd,.mermaid,.txt",e.onchange=async e=>{try{const t=e.target.files[0];if(!t)return;const r=(await t.text()).split("\n");let i=0;r.forEach((e=>{const t=e.match(/^\s*(\w+)\s+\x7b/);if(t){const e=t[1];p.tables[e]||(p.tables[e]={logicalName:e,schemaName:e,displayName:e,fields:[],relationshipsCount:0},i++)}})),i>0?(N(`Imported ${i} tables from Mermaid diagram`,"info"),ge(),Ee(),Ne(),de(`âœ“ Imported ${i} table names from Mermaid. Capture them to get full details.`),alert(`Imported ${i} table names. Use "Capture Current Table" on each to get full field and relationship details.`)):(alert("No tables found in Mermaid file."),N("No tables found in Mermaid file","warning"))}catch(e){console.error(e),alert("Error importing Mermaid: "+e.message),N("Error importing Mermaid: "+e.message,"error")}},e.click()})),t.footer){const e=n(a("button"),String.fromCharCode(9881)+" Settings");e.style.cssText=`background:transparent;border:1px solid ${k.border};color:${k.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;`,e.onclick=function(){const e=window.__lvlUpOverlay.createOverlay("Settings",{width:500,rootId:"erd-settings-overlay"});if(!e)return;let r="dark"===t.host.getAttribute("data-theme")?"dark":"light";const i=w(),s=a("div"),l=o(a("div"),"display:flex;gap:8px;margin-bottom:16px;"),c=n(a("button"),"â˜€ï¸ Light Mode"),p=n(a("button"),"ðŸŒ™ Dark Mode"),m=e=>`flex:1;padding:8px 16px;border:none;background:${e?i.primary:i.bgHover};color:${e?i.textOnPrimary:i.text};border-radius:4px;cursor:pointer;font-weight:600;`;c.style.cssText=m("light"===r),p.style.cssText=m("dark"===r);const g=a("div"),y={},u={},b=e=>{d(g),y[e]={},u[e]={};const t=C&&C[e]||v[e];Object.keys(v[e]).forEach((r=>{const d=o(a("div"),"display:flex;align-items:center;gap:8px;margin-bottom:10px;"),s=n(o(a("label"),"flex:1;font-size:13px;color:"+i.text+";"),r),l=a("input");l.type="color",l.value=t[r],l.style.cssText="width:60px;height:32px;border:1px solid "+i.border+";border-radius:4px;cursor:pointer;",y[e][r]=l;const c=a("input");c.type="text",c.value=t[r],c.maxLength=7,c.placeholder="#000000",c.style.cssText="width:80px;padding:4px 8px;border:1px solid "+i.border+";border-radius:4px;font-family:monospace;font-size:12px;text-transform:uppercase;",u[e][r]=c;const p=o(a("div"),`width:40px;height:32px;background:${t[r]};border:1px solid ${i.border};border-radius:4px;`),m=e=>{/^#[0-9A-Fa-f]{6}$/.test(e)&&(l.value=e,c.value=e.toUpperCase(),p.style.background=e)};l.addEventListener("input",(()=>{m(l.value)})),c.addEventListener("input",(()=>{const e=c.value.trim();"#"!==e.charAt(0)&&e.length>0&&(c.value="#"+e),m(c.value)})),c.addEventListener("blur",(()=>{/^#[0-9A-Fa-f]{6}$/.test(c.value)||(c.value=l.value)})),d.appendChild(s),d.appendChild(l),d.appendChild(c),d.appendChild(p),g.appendChild(d)}))};b(r),c.onclick=()=>{r="light",c.style.cssText=m(!0),p.style.cssText=m(!1),b("light")},p.onclick=()=>{r="dark",c.style.cssText=m(!1),p.style.cssText=m(!0),b("dark")},l.appendChild(c),l.appendChild(p),s.appendChild(l),s.appendChild(g);const h=o(a("div"),"display:flex;gap:8px;margin-top:16px;"),x=n(a("button"),"ðŸ’¾ Save");x.style.cssText=`flex:1;padding:8px 16px;background:${i.primary};color:${i.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`;const f=n(a("button"),"ðŸ”„ Reset to Defaults");f.style.cssText=`flex:1;padding:8px 16px;background:${i.bgHover};color:${i.text};border:1px solid ${i.border};border-radius:4px;cursor:pointer;font-weight:600;`;const E=n(a("button"),"âœ– Cancel");E.style.cssText=`flex:1;padding:8px 16px;background:${i.bgHover};color:${i.text};border:1px solid ${i.border};border-radius:4px;cursor:pointer;font-weight:600;`,x.onclick=()=>{const r={light:{},dark:{}};["light","dark"].forEach((e=>{y[e]?Object.keys(y[e]).forEach((t=>{r[e][t]=y[e][t].value})):r[e]=C&&C[e]||v[e]}));try{localStorage.setItem("crmab-erdexplorer-colors",JSON.stringify(r)),C=r,N("Settings saved","info"),e.closeOverlay(),t.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error saving settings: "+e.message)}},f.onclick=()=>{if(confirm("Reset all color settings to defaults?"))try{localStorage.removeItem("crmab-erdexplorer-colors"),C=null,N("Settings reset to defaults","info"),e.closeOverlay(),t.closeOverlay(),requestAnimationFrame((()=>{location.reload()}))}catch(e){alert("Error resetting settings: "+e.message)}},E.onclick=()=>e.closeOverlay(),h.appendChild(x),h.appendChild(f),h.appendChild(E),s.appendChild(h),e.body.appendChild(s)};const r=n(a("button"),String.fromCharCode(128276)+" Logs");r.style.cssText=`background:transparent;border:1px solid ${k.border};color:${k.text};padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px;margin-left:8px;`,r.onclick=function e(){const t=w(),r=window.__lvlUpOverlay.createOverlay("Activity Logs",{width:600,rootId:"erd-logs-overlay"});if(!r)return;const i=a("div");0===E.length?i.appendChild(n(o(a("div"),`padding:20px;text-align:center;color:${t.textMuted};`),"No activity logged yet.")):E.slice().reverse().forEach((e=>{const r=o(a("div"),`padding:8px 12px;border-bottom:1px solid ${t.borderLight};font-size:12px;color:${"error"===e.type?t.textError:t.textMuted};`),n=o(a("span"),"font-weight:600;margin-right:8px;");n.textContent=e.timestamp.toLocaleTimeString();const d=a("span");d.textContent=e.message,r.appendChild(n),r.appendChild(d),i.appendChild(r)}));const d=n(a("button"),"ðŸ—‘ Clear Logs");d.style.cssText=`width:100%;margin-top:12px;padding:8px;background:${t.danger};color:${t.textOnPrimary};border:none;border-radius:4px;cursor:pointer;font-weight:600;`,d.onclick=()=>{confirm("Clear all logs?")&&(E=[],r.closeOverlay(),e())},i.appendChild(d),r.body.appendChild(i)},t.footer.insertBefore(e,t.footer.firstChild),t.footer.insertBefore(r,t.footer.children[1])}const Re=t.closeOverlay;Re&&(t.closeOverlay=function(){m=!1,window.removeEventListener("popstate",x),window.removeEventListener("hashchange",x),window._erdOrigPushState&&(history.pushState=window._erdOrigPushState,delete window._erdOrigPushState),window._erdOrigReplaceState&&(history.replaceState=window._erdOrigReplaceState,delete window._erdOrigReplaceState),Re.call(t)}),i&&de("Current table found. Ready to capture.")}catch(e){console.error(e);const r=getColors(),i=ce("div");i.style.cssText=`color:${r.textError};margin-top:8px;padding:8px;background:${r.bgError};border-radius:4px;`,i.textContent="Error: "+(e.message||e),t.body.appendChild(i)}}();