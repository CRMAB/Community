!function(){var e=window.Xrm;if(e&&e.Page&&e.Page.ui){var t=window.__lvlUpOverlay;if(t&&"function"==typeof t.createOverlay){var a,r,o="crmab-fieldfocus-root",n=t.createOverlay("Field Focus 2.0",{rootId:o,styleId:"crmab-fieldfocus-style",width:540,maxHeight:"80vh",footer:!0,footerText:"Ready",customStyles:(a=o,r="#"+a,r+"{--ff-bg:#fff;--ff-bg-alt:#f8f8f8;--ff-border:#ddd;--ff-text:#111;--ff-muted:#605e5c;--ff-highlight:#0ea5e9;}"+r+'[data-theme="dark"]{--ff-bg:#0b1220;--ff-bg-alt:#111826;--ff-border:#374151;--ff-text:#eef2ff;--ff-muted:#9ca3af;--ff-highlight:#60a5fa;}'+r+" .crmab-ff-body{display:flex;flex-direction:column;gap:12px;font-family:'Segoe UI',Tahoma,Arial;font-size:13px;}"+r+" .crmab-ff-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}"+r+" .crmab-ff-select,"+r+" .crmab-ff-input{flex:1;min-width:120px;padding:6px 8px;border:1px solid var(--ff-border);border-radius:6px;background:var(--ff-bg);color:var(--ff-text);}"+r+" .crmab-ff-input::placeholder{color:var(--ff-muted);}"+r+" .crmab-ff-btn{border:1px solid var(--ff-border);border-radius:6px;background:var(--ff-bg-alt);color:var(--ff-text);padding:6px 10px;cursor:pointer;font-weight:600;min-width:82px;}"+r+" .crmab-ff-btn-icon{min-width:40px;font-size:16px;}"+r+" .crmab-ff-btn:disabled{opacity:.5;cursor:not-allowed;}"+r+" .crmab-ff-list{border:1px solid var(--ff-border);border-radius:8px;padding:4px;max-height:55vh;overflow:auto;background:var(--ff-bg);}"+r+" .crmab-ff-item{width:100%;border:none;background:transparent;padding:10px;border-radius:8px;display:flex;justify-content:space-between;gap:12px;text-align:left;color:var(--ff-text);cursor:pointer;}"+r+" .crmab-ff-item:hover{background:var(--ff-bg-alt);}"+r+" .crmab-ff-item-text{flex:1;}"+r+" .crmab-ff-item-title{font-weight:600;font-size:13px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;}"+r+" .crmab-ff-pill{font-size:11px;padding:1px 6px;border-radius:999px;background:var(--ff-bg-alt);border:1px solid var(--ff-border);}"+r+" .crmab-ff-meta{font-size:11px;color:var(--ff-muted);margin-top:2px;}"+r+" .crmab-ff-badge-wrap{display:flex;align-items:center;}"+r+" .crmab-ff-badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--ff-border);color:var(--ff-muted);}"+r+" .crmab-ff-badge-ok{background:#0ea5e910;color:#107c10;border-color:#3cc17c;}"+r+" .crmab-ff-empty{text-align:center;padding:18px;color:var(--ff-muted);}.crmab-ff-highlight{outline:3px solid var(--ff-highlight);outline-offset:2px;transition:outline-color .2s;}")});if(n){var i=n.body;i.classList.add("crmab-ff-body");var l=function(e,t,a){var r=document.createElement(e);return t&&(r.className=t),a&&(r.textContent=a),r},f=function(e){return window.requestAnimationFrame?window.requestAnimationFrame(e):"function"==typeof queueMicrotask?queueMicrotask(e):window.Promise?Promise.resolve().then(e):e()},c=l("div","crmab-ff-controls"),s=l("select","crmab-ff-select");[{value:"fields",label:"Fields / Columns"},{value:"tabs",label:"Tabs"},{value:"sections",label:"Sections"}].forEach((function(e){var t=l("option");t.value=e.value,t.textContent=e.label,s.appendChild(t)}));var d=l("input","crmab-ff-input");d.type="text",d.placeholder="Search (label, logical name, tab, section...)";var u=l("button","crmab-ff-btn","Display");u.type="button",u.title="Toggle between display name and logical name";var g=l("button","crmab-ff-btn","A-Z");g.type="button",g.title="Sort order";var p=l("button","crmab-ff-btn crmab-ff-btn-icon","↻");p.type="button",p.title="Refresh metadata",c.appendChild(s),c.appendChild(d),c.appendChild(u),c.appendChild(g),c.appendChild(p),i.appendChild(c);var b=l("div","crmab-ff-list");i.appendChild(b);var m=[],h=function(e,t){var a=(new Date).toISOString().substr(11,8);t=t||"info",m.push({timestamp:a,level:t,message:e}),console.log("["+a+"] ["+t.toUpperCase()+"] "+e)},v={mode:"fields",query:"",showLogical:!1,sort:"alpha",items:[]},y={fields:function(){var t=[];return N(e.Page.getAttribute(),(function(e){try{var a=e&&e.getName?e.getName():null;if(!a||!e.controls||"function"!=typeof e.controls.getLength)return;for(var r=null,o=0;o<e.controls.getLength();o++){var n=e.controls.get(o);if(k(n)){r=n;break}}if(r||(r=e.controls.getLength()?e.controls.get(0):null),!r)return;var i=r.getLabel&&r.getLabel()||a,l=r.getParent?r.getParent():null,f=l&&l.getParent?l.getParent():null,c=r.getName?r.getName():null;t.push({type:"field",label:i,logical:a,visible:E(r),control:r,section:l,tab:f,tabName:T(f),sectionName:q(l),host:S(c)})}catch(e){}})),t},tabs:function(){for(var t=[],a=e.Page.ui&&e.Page.ui.tabs?e.Page.ui.tabs.get():[],r=0;r<a.length;r++){var o=a[r],n=T(o),i=o&&o.getName?o.getName():n,l=[],f=o&&o.sections;if(f&&"function"==typeof f.getLength)for(var c=0;c<f.getLength();c++){var s=F(f.get(c));l=l.concat(s)}t.push({type:"tab",label:n,logical:i,visible:E(o),tab:o,hosts:l,host:l.length?l[0]:null,tabName:n})}return t},sections:function(){for(var t=[],a=e.Page.ui&&e.Page.ui.tabs?e.Page.ui.tabs.get():[],r=0;r<a.length;r++){var o=a[r],n=o&&o.sections;if(n&&"function"==typeof n.getLength)for(var i=0;i<n.getLength();i++){var l=n.get(i),f=F(l),c=V(l);c&&f.unshift(c),t.push({type:"section",label:q(l),logical:l&&l.getName?l.getName():"",visible:E(l),section:l,tab:o,hosts:f,host:f.length?f[0]:null,tabName:T(o),sectionName:q(l)})}}return t}},x={fields:"Fields / Columns",tabs:"Tabs",sections:"Sections"};h("Field Focus V2 initialized","success");var w=window.Intl&&"function"==typeof Intl.Collator?new Intl.Collator(void 0,{sensitivity:"base"}):null;d.addEventListener("input",(function(){var e=(d.value||"").trim();(0===e.length||e.length>=3)&&(v.query=e.toLowerCase(),M())})),s.addEventListener("change",(function(){v.mode=s.value,"fields"!==v.mode&&(v.showLogical=!1),h("Mode changed to: "+v.mode,"info"),_()})),u.addEventListener("click",(function(){"fields"===v.mode&&(v.showLogical=!v.showLogical,h("Display mode: "+(v.showLogical?"Logical":"Display"),"info"),M())})),g.addEventListener("click",(function(){v.sort="alpha"===v.sort?"group":"alpha",h("Sort order: "+v.sort,"info"),M()})),p.addEventListener("click",(function(){d.value="",v.query="",h("Manual refresh triggered - clearing filter and reloading metadata","info"),_()}));if(h("Loaded "+v.mode+" mode","info"),_(),d.focus(),n.footer){var L=l("button","crmab-ff-btn",String.fromCharCode(128220)+" Logs");L.style.cssText="background:transparent;border:1px solid var(--ff-border);color:var(--ff-text);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:8px;",L.addEventListener("click",(function(){var e=t.createOverlay("Log Viewer",{rootId:"crmab-ff-log-viewer",width:700,maxHeight:"70vh",theme:"auto"});if(e){var a=l("pre","crmab-ff-log-content");a.style.cssText="background:#f5f5f5;padding:12px;overflow:auto;max-height:500px;font-size:12px;font-family:Consolas,monospace;margin:0;color:#111;",a.textContent=m.map((function(e){return"["+e.timestamp+"] ["+e.level.toUpperCase()+"] "+e.message})).join("\n"),e.body.appendChild(a);var r=l("button","crmab-ff-btn","Copy to Clipboard");r.style.cssText="margin-top:12px;padding:6px 12px;background:#0078d4;color:#fff;border:none;border-radius:4px;cursor:pointer;",r.addEventListener("click",(function(){navigator.clipboard.writeText(a.textContent).then((function(){alert("Logs copied to clipboard")}))})),e.body.appendChild(r)}})),L.addEventListener("mouseenter",(function(){this.style.background="rgba(0,0,0,0.05)"})),L.addEventListener("mouseleave",(function(){this.style.background="transparent"}));var C=n.footer.lastChild;C&&1===C.nodeType?n.footer.insertBefore(L,C):n.footer.appendChild(L)}}}else alert("helperOverlayV2.js must be loaded.")}else alert("Form context not available.");function N(e,t){if(e)if("function"!=typeof e.forEach)if("function"!=typeof e.getLength||"function"!=typeof e.get){if("number"==typeof e.length)for(var a=0;a<e.length;a++)t(e[a],a)}else for(var r=0;r<e.getLength();r++)t(e.get(r),r);else e.forEach(t)}function k(e){if(!e||!e.getControlType)return!1;var t=e.getControlType();return-1===["timeline","subgrid","quickform","kbsearch","webresource","iframe"].indexOf(t)}function S(e){return e?document.querySelector("[data-control-name='"+e+"']"):null}function T(e){return e?e.getLabel?e.getLabel()||"":e.getName&&e.getName()||"":""}function q(e){return e?e.getLabel?e.getLabel()||"":e.getName&&e.getName()||"":""}function P(e,t){return t||0===t?"["+e+'="'+String(t).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"]':null}function V(e){if(!e)return null;var t=e.getName?e.getName():"",a=q(e),r=t?t.toLowerCase():"",o=a?a.toLowerCase():"",n=[];t&&(n.push(P("data-id","Section_"+t)),n.push(P("data-id",t)),n.push(P("data-id","section_"+r))),a&&n.push(P("aria-label",a));for(var i=0;i<n.length;i++){var l=n[i];if(l){var f=document.querySelector(l);if(f)return f}}for(var c=document.querySelectorAll("[data-id^='section_'], section[aria-label]"),s=0;s<c.length;s++){var d=c[s],u=(d.getAttribute("data-id")||"").toLowerCase();if(r&&-1!==u.indexOf(r))return d;var g=(d.getAttribute("aria-label")||"").toLowerCase();if(o&&g===o)return d}return null}function E(e){try{return!!(e&&e.getVisible&&e.getVisible())}catch(e){return!0}}function F(e){var t=[];if(!e||!e.controls||"function"!=typeof e.controls.getLength)return t;for(var a=0;a<e.controls.getLength();a++){var r=e.controls.get(a),o=S(r&&r.getName?r.getName():null);o&&t.push(o)}return t}function D(e){if(e&&e.length){var t=e[0];try{t.scrollIntoView({behavior:"smooth",block:"center"})}catch(e){t.scrollIntoView(!0)}!function(e){if(e&&e.length){for(var t=0;t<e.length;t++){var a=e[t];try{a&&a.classList&&a.classList.add("crmab-ff-highlight")}catch(e){}}var r=window.performance&&performance.now?performance.now():Date.now(),o=function(t){if((t||Date.now())-r>=1200)for(var a=0;a<e.length;a++){var n=e[a];try{n&&n.classList&&n.classList.remove("crmab-ff-highlight")}catch(e){}}else f(o)};f(o)}}(e)}}function I(e){if(e){try{e.setVisible&&e.setVisible(!0)}catch(e){}try{e.setDisplayState&&e.setDisplayState("expanded")}catch(e){}}}function O(e){try{e&&e.setFocus&&e.setFocus()}catch(e){}}function z(e){return"field"===e.type&&v.showLogical?e.logical||"":e.label||e.logical||""}function A(e,t){if(w)return w.compare(e||"",t||"");var a=(e||"").toLowerCase(),r=(t||"").toLowerCase();return a<r?-1:a>r?1:0}function j(e){var t=l("button","crmab-ff-item");t.type="button";var a=l("div","crmab-ff-item-text"),r=l("div","crmab-ff-item-title",z(e)),o=function(e){return"field"===e.type?v.showLogical?e.label||"":e.logical||"":e.logical&&e.logical!==e.label?e.logical:""}(e);if(o){var n=l("span","crmab-ff-pill",o);r.appendChild(n)}var i=l("div","crmab-ff-meta",function(e){if("field"===e.type){var t=[];return e.tabName&&t.push(e.tabName),e.sectionName&&t.push(e.sectionName),t.join(" · ")}return"tab"===e.type?"Tab":e.tabName||""}(e));a.appendChild(r),a.appendChild(i);var f=l("div","crmab-ff-badge-wrap"),c=l("span",e.visible?"crmab-ff-badge crmab-ff-badge-ok":"crmab-ff-badge");return c.textContent=e.visible?"visible":"hidden",f.appendChild(c),t.appendChild(a),t.appendChild(f),t.addEventListener("click",(function(){!function(e){var t=b.scrollTop;try{if("field"===e.type){try{e.control&&e.control.setVisible&&e.control.setVisible(!0)}catch(e){}try{e.section&&e.section.setVisible&&e.section.setVisible(!0)}catch(e){}I(e.tab),O(e.control),e.host||(e.host=S(e.control&&e.control.getName?e.control.getName():null)),D(e.host?[e.host]:[])}else if("tab"===e.type){I(e.tab);var a=null;try{var r=e.tab&&e.tab.sections;if(r&&"function"==typeof r.getLength&&r.getLength()>0){var o=r.get(0);o&&o.controls&&"function"==typeof o.controls.getLength&&o.controls.getLength()>0&&(a=o.controls.get(0))}}catch(e){}O(a),D(e.hosts&&e.hosts.length?e.hosts:e.host?[e.host]:[])}else if("section"===e.type){I(e.tab);try{e.section&&e.section.setVisible&&e.section.setVisible(!0)}catch(e){}D(e.hosts&&e.hosts.length?e.hosts:e.host?[e.host]:[])}}catch(e){alert("Navigation failed: "+(e.message||e))}finally{v.items=y[v.mode]?y[v.mode]():[],M(),b.scrollTop=t}}(e)})),t}function M(){var e=y[v.mode]?v.items.slice():[];for(e=function(e){if(!v.query)return e.slice();var t=v.query.split(/\s+/).filter((function(e){return!!e}));return t.length?e.filter((function(e){for(var a=[e.label||"",e.logical||"",e.tabName||e.tabLabel||"",e.sectionName||""].join("|").toLowerCase(),r=0;r<t.length;r++)if(-1===a.indexOf(t[r]))return!1;return!0})):e.slice()}(e),function(e){e.sort((function(e,t){if("alpha"===v.sort||"tab"===e.type||"tab"===t.type)return A(z(e),z(t));var a=A(e.tabName||"",t.tabName||"");if(a)return a;if("section"===e.type||"section"===t.type){var r=A(e.sectionName||e.label||"",t.sectionName||t.label||"");if(r)return r}return A(z(e),z(t))}))}(e);b.firstChild;)b.removeChild(b.firstChild);if(e.length){for(var t=document.createDocumentFragment(),a=0;a<e.length;a++)t.appendChild(j(e[a]));b.appendChild(t)}else b.appendChild(l("div","crmab-ff-empty","No objects found."));n.updateFooter("Objects: "+e.length+" • Mode: "+(x[v.mode]||"")),h("Rendered "+e.length+" "+v.mode+(v.query?" (filtered by: '"+v.query+"')":""),"info"),u.disabled="fields"!==v.mode,u.textContent=v.showLogical?"Logical":"Display",g.textContent="alpha"===v.sort?"A-Z":"Tab/Section"}function _(){v.items=y[v.mode]?y[v.mode]():[],M()}}();